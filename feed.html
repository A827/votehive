<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Feed – VoteHive</title>
  <link rel="icon" href="/favicon.ico"/><link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-white text-gray-800 font-sans">
  <div id="vh-header"></div>
  <script src="header.js"></script>

  <main class="max-w-7xl mx-auto px-4 py-10 grid gap-6 md:grid-cols-3">
    <aside class="bg-white border border-gray-100 shadow rounded p-4">
      <h2 class="text-lg font-semibold mb-2">Filters</h2>
      <label class="flex items-center gap-2"><input type="checkbox" class="f" value="vote" checked>Votes</label>
      <label class="flex items-center gap-2"><input type="checkbox" class="f" value="share" checked>Shares</label>
      <label class="flex items-center gap-2"><input type="checkbox" class="f" value="comment" checked>Comments</label>
      <label class="flex items-center gap-2"><input type="checkbox" class="f" value="create" checked>Created</label>
      <label class="flex items-center gap-2"><input type="checkbox" class="f" value="approve" checked>Approved</label>
      <input id="q" class="mt-4 w-full border rounded px-3 py-2 text-sm" placeholder="Search…"/>
    </aside>
    <section class="md:col-span-2">
      <div id="empty" class="hidden text-center text-gray-500 bg-gray-50 p-10 rounded">No activity yet.</div>
      <div id="feed" class="space-y-3"></div>
    </section>
  </main>

  <footer class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white py-8 mt-16">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm"><span>© 2025 VoteHive</span><div class="flex gap-6"><a href="#" class="hover:underline">About</a><a href="#" class="hover:underline">Contact</a></div></div>
  </footer>

  <script>
    const feedEl=document.getElementById('feed'), empty=document.getElementById('empty'), q=document.getElementById('q'), filters=[...document.querySelectorAll('.f')];
    const getEarned = ()=> JSON.parse(localStorage.getItem('vh_pointsEarned')||'{}');
    const getComments = ()=> JSON.parse(localStorage.getItem('pollComments')||'{}');
    const getLog = ()=> JSON.parse(localStorage.getItem('applicationLog')||'[]');
    const getPolls = ()=> JSON.parse(localStorage.getItem('customPolls')||'{}');

    function items(){
      const out=[]; const polls=getPolls(); const earned=getEarned(); const comments=getComments(); const logs=getLog();
      Object.keys(earned).forEach(k=>{
        const [type,user,pid]=k.split(':'); if(!polls[pid]) return;
        if(type==='vote') out.push({type,user,title:polls[pid].title,pid,ts: polls[pid].createdAt});
        if(type==='share') out.push({type,user,title:polls[pid].title,pid,ts: polls[pid].createdAt});
      });
      Object.entries(comments).forEach(([pid,list])=>{
        const poll=polls[pid]; if(!poll) return;
        list.forEach(c=> out.push({type:'comment', user:c.user, title:poll.title, pid, ts:c.ts}));
      });
      logs.forEach(l=>{
        if(l.status==='approved') out.push({type:'approve', user:l.applicant, title:l.title, pid:'-', ts:l.updatedAt||l.createdAt});
        else out.push({type:'create', user:l.applicant, title:l.title, pid:'-', ts:l.createdAt});
      });
      return out.sort((a,b)=> new Date(b.ts) - new Date(a.ts));
    }
    function color(t){ if(t==='vote')return'bg-purple-100 text-purple-800'; if(t==='share')return'bg-blue-100 text-blue-800'; if(t==='comment')return'bg-green-100 text-green-800'; if(t==='create')return'bg-yellow-100 text-yellow-800'; if(t==='approve')return'bg-indigo-100 text-indigo-800'; return'bg-gray-100 text-gray-800'; }
    function icon(t){ return t==='vote'?'🗳️':t==='share'?'🔗':t==='comment'?'💬':t==='create'?'📝':t==='approve'?'✅':'•'; }
    function applyFilters(arr){
      const allow=new Set(filters.filter(f=>f.checked).map(f=>f.value));
      const term=(q.value||'').toLowerCase().trim();
      return arr.filter(i=>{
        if(!allow.has(i.type)) return false;
        if(!term) return true;
        return (i.user||'').toLowerCase().includes(term) || (i.title||'').toLowerCase().includes(term);
      });
    }
    function render(){
      const arr=applyFilters(items());
      if(!arr.length){ empty.classList.remove('hidden'); feedEl.innerHTML=''; return; }
      empty.classList.add('hidden');
      feedEl.innerHTML = arr.map(i=>`
        <article class="bg-white border border-gray-100 shadow rounded p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded-full text-xs ${color(i.type)}">${icon(i.type)} ${i.type}</span>
              <span class="text-xs text-gray-500">${new Date(i.ts).toLocaleString()}</span>
            </div>
            ${i.pid && i.pid!=='-' ? `<a href="poll.html?id=${encodeURIComponent(i.pid)}" class="text-sm text-indigo-600 hover:underline">Open</a>`:''}
          </div>
          <div class="mt-2 text-sm"><span class="font-semibold">${i.user}</span> — ${i.title}</div>
        </article>`).join('');
    }
    q.addEventListener('input', render); filters.forEach(f=>f.addEventListener('change', render)); render();
    setInterval(render, 5000);
  </script>
</body>
</html>