<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Create a Poll – VoteHive</title>
  <link rel="icon" href="/favicon.ico"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    .chip{display:inline-block;padding:2px 10px;border-radius:9999px;font-size:12px;line-height:20px}
    .hint{font-size:12px;color:#6b7280}
    .err{color:#b91c1c;font-size:12px}
    .opt-item{display:flex;gap:.5rem;align-items:center;margin-top:.5rem}
    .opt-item input{flex:1}
  </style>
</head>
<body class="bg-white text-gray-800 font-sans">
  <!-- Header -->
  <div id="vh-header"></div>
  <script src="auth.js"></script>
  <script src="guard.js"></script>
  <script>requireLogin();</script>
  <script src="header.js"></script>

  <main class="max-w-3xl mx-auto px-4 py-10">
    <h1 class="text-2xl md:text-3xl font-bold mb-2">Apply to Create a Poll</h1>
    <p class="text-gray-600">Submit your idea. A moderator will review and approve it to go live.</p>

    <div id="msg" class="hidden mt-4 p-3 rounded text-sm"></div>

    <form id="form" class="bg-white border border-gray-100 shadow rounded p-6 mt-6">
      <!-- Title -->
      <div class="mb-4">
        <label class="block font-semibold mb-1">Title <span class="hint">(max 120)</span></label>
        <input id="title" maxlength="120" class="w-full border rounded px-3 py-2" placeholder="e.g., Which coffee chain wins in 2025?">
        <div id="e_title" class="err hidden">Please enter a title (min 8 chars).</div>
      </div>

      <!-- Category + Tags -->
      <div class="grid md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block font-semibold mb-1">Category</label>
          <select id="category" class="w-full border rounded px-3 py-2">
            <option value="">Choose…</option>
            <option>Startups</option><option>Brands</option><option>Politics</option>
            <option>Finance</option><option>Design</option><option>Parenting</option>
            <option>Real Estate</option><option>Entertainment</option><option>General</option>
          </select>
          <div id="e_category" class="err hidden">Pick a category.</div>
        </div>
        <div>
          <label class="block font-semibold mb-1">Tags <span class="hint">(comma-separated, optional)</span></label>
          <input id="tags" class="w-full border rounded px-3 py-2" placeholder="e.g., coffee, retail">
        </div>
      </div>

      <!-- Thumbnail -->
      <div class="mb-4">
        <label class="block font-semibold mb-1">Thumbnail URL <span class="hint">(optional)</span></label>
        <input id="thumb" class="w-full border rounded px-3 py-2" placeholder="https://…">
        <div class="hint mt-1">Used on cards/spotlights if provided.</div>
      </div>

      <!-- Options builder -->
      <div class="mb-4">
        <label class="block font-semibold mb-1">Options</label>
        <div id="opts"></div>
        <div class="flex gap-2 mt-2">
          <button type="button" id="addOpt" class="px-3 py-1 rounded text-sm bg-gray-100 hover:bg-gray-200">+ Add option</button>
          <button type="button" id="clearOpts" class="px-3 py-1 rounded text-sm bg-gray-100 hover:bg-gray-200">Clear</button>
        </div>
        <div id="e_opts" class="err hidden mt-1">Add at least 2 options.</div>
      </div>

      <!-- Settings -->
      <div class="grid md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block font-semibold mb-1">Start (optional)</label>
          <input id="startAt" type="datetime-local" class="w-full border rounded px-3 py-2">
          <div class="hint mt-1">If set, your poll will be scheduled.</div>
        </div>
        <div>
          <label class="block font-semibold mb-1">Duration</label>
          <select id="duration" class="w-full border rounded px-3 py-2">
            <option value="1">1 day</option>
            <option value="3">3 days</option>
            <option value="7" selected>7 days</option>
            <option value="14">14 days</option>
            <option value="30">30 days</option>
          </select>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block font-semibold mb-1">Allow multiple selections?</label>
          <select id="multi" class="w-full border rounded px-3 py-2">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
        <div>
          <label class="block font-semibold mb-1">Comments</label>
          <select id="comments" class="w-full border rounded px-3 py-2">
            <option value="on" selected>Enabled</option>
            <option value="off">Disabled</option>
          </select>
        </div>
      </div>

      <!-- Rationale -->
      <div class="mb-4">
        <label class="block font-semibold mb-1">Why this poll? <span class="hint">(optional, helps moderators)</span></label>
        <textarea id="reason" rows="3" class="w-full border rounded px-3 py-2" placeholder="Short context, sources, or why this matters now."></textarea>
      </div>

      <!-- Actions -->
      <div class="flex flex-wrap gap-2">
        <button id="submitBtn" class="px-4 py-2 rounded text-sm bg-indigo-600 text-white hover:bg-indigo-700">Submit for review</button>
        <button id="saveDraft" type="button" class="px-4 py-2 rounded text-sm bg-gray-100 hover:bg-gray-200">Save draft</button>
        <button id="loadDraft" type="button" class="px-4 py-2 rounded text-sm bg-gray-100 hover:bg-gray-200">Load draft</button>
        <button id="clearDraft" type="button" class="px-4 py-2 rounded text-sm bg-gray-100 hover:bg-gray-200">Clear draft</button>
      </div>
    </form>
  </main>

  <footer class="bg-gray-50 mt-12">
    <div class="max-w-7xl mx-auto px-4 py-8 text-sm flex items-center justify-between">
      <div class="flex items-center gap-2"><img src="/logo.svg" class="w-6 h-6" alt=""><span class="font-semibold">VoteHive</span></div>
      <div class="text-gray-500">© 2025 VoteHive</div>
    </div>
  </footer>

  <script>
    // ---------- storage helpers ----------
    function getUsers(){ try { return JSON.parse(localStorage.getItem('vh_users')||'{}'); } catch(e){ return {}; } }
    function getSession(){ try { return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch(e){ return null; } }
    function getLog(){ try { return JSON.parse(localStorage.getItem('applicationLog')||'[]'); } catch(e){ return []; } }
    function setLog(v){ localStorage.setItem('applicationLog', JSON.stringify(v)); }
    function saveDraftObj(v){ localStorage.setItem('draftCreatePoll', JSON.stringify(v)); }
    function loadDraftObj(){ try { return JSON.parse(localStorage.getItem('draftCreatePoll')||'null'); } catch(e){ return null; } }

    // ---------- option builder ----------
    var optsEl = document.getElementById('opts');
    function makeOptRow(val){
      var wrap = document.createElement('div'); wrap.className = 'opt-item';
      var input = document.createElement('input'); input.className='border rounded px-3 py-2'; input.placeholder='Option'; input.value = val || '';
      var up = document.createElement('button'); up.type='button'; up.className='px-2 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded'; up.textContent='↑';
      var dn = document.createElement('button'); dn.type='button'; dn.className='px-2 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded'; dn.textContent='↓';
      var del= document.createElement('button'); del.type='button'; del.className='px-2 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded'; del.textContent='✕';
      up.onclick=function(){ var p=wrap.previousElementSibling; if(p) optsEl.insertBefore(wrap,p); };
      dn.onclick=function(){ var n=wrap.nextElementSibling; if(n) optsEl.insertBefore(n,wrap); };
      del.onclick=function(){ optsEl.removeChild(wrap); };
      wrap.appendChild(input); wrap.appendChild(up); wrap.appendChild(dn); wrap.appendChild(del);
      return wrap;
    }
    function ensureMinOptions(){
      if (!optsEl.children.length){
        optsEl.appendChild(makeOptRow('Option A'));
        optsEl.appendChild(makeOptRow('Option B'));
      }
    }
    document.getElementById('addOpt').onclick = function(){ optsEl.appendChild(makeOptRow('')); };
    document.getElementById('clearOpts').onclick = function(){ optsEl.innerHTML=''; ensureMinOptions(); };
    ensureMinOptions();

    // ---------- validation ----------
    function valTrim(id){ return (document.getElementById(id).value||'').trim(); }
    function showErr(id, show){ var el=document.getElementById(id); if(!el) return; if(show){ el.classList.remove('hidden'); } else { el.classList.add('hidden'); } }
    function collectOptions(){
      var out=[], i, kids = optsEl.children;
      for (i=0;i<kids.length;i++){
        var v = (kids[i].querySelector('input').value||'').trim();
        if (v) out.push(v);
      }
      return out;
    }
    function isValidURL(url){
      if (!url) return true;
      try { var u = new URL(url); return !!u.protocol && !!u.hostname; } catch(e){ return false; }
    }
    function validate(){
      var ok = true;
      var title = valTrim('title');
      var cat   = valTrim('category');
      var thumb = valTrim('thumb');
      var opts  = collectOptions();

      showErr('e_title', !(title && title.length>=8));
      if (!(title && title.length>=8)) ok=false;

      showErr('e_category', !cat);
      if (!cat) ok=false;

      showErr('e_opts', !(opts && opts.length>=2));
      if (!(opts && opts.length>=2)) ok=false;

      if (thumb && !isValidURL(thumb)){ ok=false; var m=document.getElementById('msg'); m.className='mt-4 p-3 rounded text-sm bg-red-50 text-red-700 border border-red-200'; m.textContent='Thumbnail URL looks invalid.'; m.classList.remove('hidden'); }

      return ok;
    }

    // ---------- submit ----------
    function toISOOrNull(localDT){
      if (!localDT) return null;
      var dt = new Date(localDT);
      if (isNaN(dt.getTime())) return null;
      // local -> UTC ISO
      return new Date(dt.getTime() + dt.getTimezoneOffset()*60000).toISOString();
    }

    function submitApplication(){
      if (!validate()) return;

      var me = getSession();
      var username = me && me.username ? me.username : 'guest';

      var title = valTrim('title');
      var category = valTrim('category');
      var tags = valTrim('tags');
      var thumb = valTrim('thumb');
      var opts = collectOptions();
      var startLocal = valTrim('startAt');
      var durationDays = parseInt(document.getElementById('duration').value,10) || 7;
      var startAt = toISOOrNull(startLocal);
      var endTime;
      if (startAt) {
        endTime = new Date(new Date(startAt).getTime() + durationDays*24*60*60*1000).toISOString();
      } else {
        endTime = new Date(Date.now() + durationDays*24*60*60*1000).toISOString();
      }
      var multi = document.getElementById('multi').value === 'yes';
      var comments = document.getElementById('comments').value === 'on';
      var reason = valTrim('reason');

      // application record
      var app = {
        id: 'app-' + Date.now() + Math.random().toString(36).slice(2),
        applicant: username,
        title: title,
        category: category || 'General',
        tags: tags ? tags.split(',').map(function(s){return s.trim();}).filter(Boolean) : [],
        thumbnail: thumb || '',
        options: opts,
        startAt: startAt,                // scheduling hint
        requestedDays: durationDays,     // moderator can override
        endTimeHint: endTime,            // helpful preview
        multiSelect: !!multi,
        commentsEnabled: !!comments,
        reason: reason || '',
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      var log = getLog();
      log.push(app);
      setLog(log);

      // small UX: clear draft on successful submit
      localStorage.removeItem('draftCreatePoll');

      var m = document.getElementById('msg');
      m.className = 'mt-4 p-3 rounded text-sm bg-green-50 text-green-800 border border-green-200';
      m.textContent = 'Application submitted! A moderator will review it shortly.';
      m.classList.remove('hidden');

      // reset form (keep two option rows)
      document.getElementById('form').reset();
      optsEl.innerHTML=''; ensureMinOptions();
      // optional redirect:
      // setTimeout(function(){ location.href='applications.html'; }, 800);
    }

    document.getElementById('submitBtn').addEventListener('click', function(e){
      e.preventDefault();
      submitApplication();
    });

    // ---------- drafts ----------
    function collectForm(){
      return {
        title: valTrim('title'),
        category: valTrim('category'),
        tags: valTrim('tags'),
        thumb: valTrim('thumb'),
        options: collectOptions(),
        startAt: valTrim('startAt'),
        duration: document.getElementById('duration').value,
        multi: document.getElementById('multi').value,
        comments: document.getElementById('comments').value,
        reason: valTrim('reason')
      };
    }
    function fillForm(d){
      if (!d) return;
      document.getElementById('title').value = d.title || '';
      document.getElementById('category').value = d.category || '';
      document.getElementById('tags').value = d.tags || '';
      document.getElementById('thumb').value = d.thumb || '';
      optsEl.innerHTML='';
      var i, list = d.options && d.options.length ? d.options : ['Option A','Option B'];
      for(i=0;i<list.length;i++) optsEl.appendChild(makeOptRow(list[i]));
      document.getElementById('startAt').value = d.startAt || '';
      document.getElementById('duration').value = d.duration || '7';
      document.getElementById('multi').value = d.multi || 'no';
      document.getElementById('comments').value = d.comments || 'on';
      document.getElementById('reason').value = d.reason || '';
    }

    document.getElementById('saveDraft').addEventListener('click', function(){
      var d = collectForm();
      saveDraftObj(d);
      var m = document.getElementById('msg');
      m.className = 'mt-4 p-3 rounded text-sm bg-blue-50 text-blue-800 border border-blue-200';
      m.textContent = 'Draft saved locally.';
      m.classList.remove('hidden');
    });
    document.getElementById('loadDraft').addEventListener('click', function(){
      var d = loadDraftObj();
      if (!d){
        var m = document.getElementById('msg');
        m.className = 'mt-4 p-3 rounded text-sm bg-yellow-50 text-yellow-800 border border-yellow-200';
        m.textContent = 'No draft found.';
        m.classList.remove('hidden');
        return;
      }
      fillForm(d);
      var m2 = document.getElementById('msg');
      m2.className = 'mt-4 p-3 rounded text-sm bg-blue-50 text-blue-800 border border-blue-200';
      m2.textContent = 'Draft loaded.';
      m2.classList.remove('hidden');
    });
    document.getElementById('clearDraft').addEventListener('click', function(){
      localStorage.removeItem('draftCreatePoll');
      var m = document.getElementById('msg');
      m.className = 'mt-4 p-3 rounded text-sm bg-gray-100 text-gray-800 border border-gray-200';
      m.textContent = 'Draft cleared.';
      m.classList.remove('hidden');
    });

    // Auto-fill from draft on first load
    (function(){ var d=loadDraftObj(); if(d) fillForm(d); })();
  </script>
</body>
</html>