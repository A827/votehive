<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Poll – VoteHive</title>
  <link rel="icon" href="/favicon.ico"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    .pill{padding:4px 10px;border-radius:9999px;font-size:12px;display:inline-block}
    .countdown{font-variant-numeric:tabular-nums}
    .btn{display:inline-flex;align-items:center;gap:6px}
    .emoji{cursor:pointer;user-select:none}
    .clamp2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  </style>
</head>
<body class="bg-white text-gray-800 font-sans">

  <!-- Header mount (required) -->
  <div id="vh-header"></div>
  <script src="guard.js"></script>
  <script src="header.js"></script>

  <main class="max-w-5xl mx-auto px-4 py-8">
    <a href="browse.html" class="text-sm text-indigo-600 hover:underline">← Back to Browse</a>

    <div id="wrap" class="mt-4 bg-white border border-gray-100 shadow rounded p-5">
      <h1 id="title" class="text-2xl font-bold mb-1">Loading…</h1>
      <div class="flex flex-wrap items-center gap-2 text-sm text-gray-600">
        <span id="cat" class="pill bg-gray-100 text-gray-700">General</span>
        <span id="state" class="pill">Open</span>
        <span id="ends" class="pill bg-indigo-100 text-indigo-700 countdown">Ends —</span>
      </div>

      <div id="desc" class="mt-4 text-gray-700 hidden"></div>

      <section class="mt-6">
        <h2 class="text-lg font-semibold mb-3">Vote</h2>
        <div id="opts" class="grid gap-2"></div>
        <div id="note" class="mt-2 text-xs text-gray-500"></div>
      </section>

      <section class="mt-8">
        <h3 class="text-lg font-semibold mb-2">Share</h3>
        <div class="flex gap-2">
          <input id="link" class="border rounded px-3 py-2 w-full text-sm" readonly/>
          <button id="copy" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded text-sm">Copy</button>
        </div>
        <p class="text-xs text-gray-500 mt-1">Share this link to invite votes.</p>
      </section>

      <!-- Discussions -->
      <section class="mt-10">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Discussion</h3>
          <div class="flex items-center gap-2 text-sm">
            <label class="text-gray-600">Sort:</label>
            <select id="sort" class="border rounded px-2 py-1">
              <option value="top">Top</option>
              <option value="new">New</option>
              <option value="active">Active</option>
            </select>
          </div>
        </div>

        <!-- New comment -->
        <div id="commentForm" class="mt-3 mb-5">
          <textarea id="cText" rows="3" class="w-full border rounded px-3 py-2 text-sm" placeholder="Add a comment… (login required)"></textarea>
          <div class="mt-2 flex items-center justify-between">
            <span id="cHint" class="text-xs text-gray-500">You’re not logged in.</span>
            <div class="flex items-center gap-2">
              <button id="cPost" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-sm">Post</button>
            </div>
          </div>
        </div>

        <div id="thread" class="space-y-4"></div>
        <div id="none" class="text-sm text-gray-500">No comments yet. Be the first to share your view.</div>
        <div id="moreWrap" class="mt-4 hidden">
          <button id="loadMore" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded text-sm">Load more</button>
        </div>
      </section>
    </div>
  </main>

  <footer class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white py-8 mt-12">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
      <span>© 2025 VoteHive</span>
      <div class="flex gap-6"><a href="#" class="hover:underline">About</a><a href="#" class="hover:underline">Contact</a></div>
    </div>
  </footer>

  <script>
    // ========= Helpers / Storage =========
    const pid = new URLSearchParams(location.search).get('id') || 'test';
    const me = (window.VHAuth?.current?.() || null); // {username, role}? or null

    // Polls & votes (existing)
    const getPolls = () => JSON.parse(localStorage.getItem('customPolls') || '{}');
    const setPolls = (d) => localStorage.setItem('customPolls', JSON.stringify(d));
    const getVotes = () => JSON.parse(localStorage.getItem('pollVotes') || '{}');
    const setVotes = (d) => localStorage.setItem('pollVotes', JSON.stringify(d));
    const getUserVotes = () => JSON.parse(localStorage.getItem('userVotes') || '{}');
    const setUserVotes = (d) => localStorage.setItem('userVotes', JSON.stringify(d));
    const getPoints = () => JSON.parse(localStorage.getItem('userPoints') || '{}');
    const setPoints = (d) => localStorage.setItem('userPoints', JSON.stringify(d));
    const getEarned = () => JSON.parse(localStorage.getItem('vh_pointsEarned') || '{}');
    const setEarned = (d) => localStorage.setItem('vh_pointsEarned', JSON.stringify(d));

    // Social: comments, reactions, reports, activity
    const getComments = () => JSON.parse(localStorage.getItem('pollComments') || '{}'); // {pid: [ {id,user,text,ts,parentId,reactions,replies,lastActive,edits,deleted,reports} ]}
    const setComments = (d) => localStorage.setItem('pollComments', JSON.stringify(d));
    const getUserReactions = () => JSON.parse(localStorage.getItem('userReactions') || '{}'); // {pid:{commentId:{username:'like'|'heart'|'idea'|'laugh'}}}
    const setUserReactions = (d) => localStorage.setItem('userReactions', JSON.stringify(d));
    const getReports = () => JSON.parse(localStorage.getItem('commentReports') || '{}'); // {pid:{commentId:{username:true}}}
    const setReports = (d) => localStorage.setItem('commentReports', JSON.stringify(d));
    const getActivity = () => JSON.parse(localStorage.getItem('activityLog') || '[]'); // [ {type, pid, user, action, ts, meta} ]
    const setActivity = (d) => localStorage.setItem('activityLog', JSON.stringify(d));

    function addActivity(evt){ const log = getActivity(); log.push(evt); setActivity(log.slice(-500)); }

    function esc(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function fmtTime(date){ return new Date(date).toLocaleString(); }
    function mentionize(s){ return esc(s).replace(/@([a-zA-Z0-9_]{2,24})/g, '<span class="text-indigo-600">@$1</span>'); }

    // ========= Render poll =========
    function fmtCountdown(end) {
      const ms = end - new Date();
      if (ms <= 0) return 'Closed';
      const s = Math.floor(ms/1000);
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      const ss= s % 60;
      return `${d}d ${h}h ${m}m ${ss}s`;
    }

    function totalVotesFor(pollId){
      const v = getVotes()[pollId] || {};
      return Object.values(v).reduce((a,b)=>a + (Number(b)||0), 0);
    }

    function renderPoll() {
      const polls = getPolls();
      const p = polls[pid];
      const titleEl = document.getElementById('title');
      const catEl   = document.getElementById('cat');
      const stateEl = document.getElementById('state');
      const endsEl  = document.getElementById('ends');
      const optsEl  = document.getElementById('opts');
      const noteEl  = document.getElementById('note');
      const linkEl  = document.getElementById('link');

      if (!p) {
        titleEl.textContent = 'Poll not found';
        optsEl.innerHTML = '<div class="text-sm text-gray-500">No options available.</div>';
        return;
      }

      const end = new Date(p.endTime);
      const closed = isNaN(end) ? false : (Date.now() > end.getTime());

      titleEl.textContent = p.title || 'Untitled poll';
      catEl.textContent = p.category || 'General';
      stateEl.textContent = closed ? 'Closed' : 'Open';
      stateEl.className = 'pill ' + (closed ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700');

      // Countdown
      if (!isNaN(end)) {
        const upd = () => { endsEl.textContent = 'Ends: ' + fmtCountdown(end); };
        upd();
        setInterval(upd, 1000);
      } else {
        endsEl.textContent = 'Ends: N/A';
      }

      // Voting UI
      const votes = getVotes();
      const userVotes = getUserVotes();
      const myVote = (me && userVotes[pid] && userVotes[pid][me.username] !== undefined)
        ? userVotes[pid][me.username] : null;

      const counts = votes[pid] || {}; // { "0": 10, "1": 3, ... }
      const total = (p.options || []).reduce((acc, _, i) => acc + (counts[i] || 0), 0);

      optsEl.innerHTML = (p.options || []).map((opt, i) => {
        const c = counts[i] || 0;
        const pct = total ? Math.round((c / total) * 100) : 0;
        const isMine = myVote === i;
        return `
          <button data-idx="${i}" class="group w-full text-left border rounded px-3 py-3 hover:bg-gray-50 ${isMine?'border-indigo-300 bg-indigo-50':''}" ${closed?'disabled':''}>
            <div class="flex items-center justify-between">
              <span class="font-medium">${esc(opt)}</span>
              <span class="text-sm text-gray-500">${c} • ${pct}%</span>
            </div>
            <div class="h-2 mt-2 rounded bg-gray-100">
              <div class="h-2 rounded ${isMine?'bg-indigo-500':'bg-indigo-300'}" style="width:${pct}%;"></div>
            </div>
          </button>`;
      }).join('');

      if (closed) {
        noteEl.textContent = 'This poll is closed. Voting is disabled.';
      } else if (!me) {
        noteEl.innerHTML = 'Log in to vote. <a class="text-indigo-600 hover:underline" href="login.html?next=' + encodeURIComponent(location.pathname + location.search) + '">Log in</a>';
      } else if (myVote !== null) {
        noteEl.textContent = `You voted for option #${myVote + 1}.`;
      } else {
        noteEl.textContent = 'One vote per user.';
      }

      // Bind votes
      optsEl.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.addEventListener('click', () => {
          if (closed) return;
          if (!me) { location.href = 'login.html?next=' + encodeURIComponent(location.pathname + location.search); return; }
          const idx = Number(btn.getAttribute('data-idx'));
          const uv = getUserVotes();
          if (!uv[pid]) uv[pid] = {};
          if (uv[pid][me.username] !== undefined) { renderPoll(); return; }

          const vv = getVotes();
          if (!vv[pid]) vv[pid] = {};
          vv[pid][idx] = (vv[pid][idx] || 0) + 1;
          setVotes(vv);

          uv[pid][me.username] = idx;
          setUserVotes(uv);

          // Points +2 for vote
          const pts = getPoints(); pts[me.username] = (pts[me.username] || 0) + 2; setPoints(pts);
          const earned = getEarned(); earned[`vote:${me.username}:${pid}`] = new Date().toISOString(); setEarned(earned);
          addActivity({type:'vote', pid, user:me.username, action:'vote', ts:Date.now(), meta:{option:idx}});

          renderPoll();
        });
      });

      linkEl.value = location.origin + location.pathname + '?id=' + encodeURIComponent(pid);
    }

    // Copy share link
    document.getElementById('copy').addEventListener('click', async () => {
      const link = document.getElementById('link').value;
      try {
        await navigator.clipboard.writeText(link);
        if (me) {
          const earned = getEarned();
          const key = `share:${me.username}:${pid}`;
          if (!earned[key]) {
            earned[key] = new Date().toISOString();
            setEarned(earned);
            const pts = getPoints(); pts[me.username] = (pts[me.username] || 0) + 1; setPoints(pts);
            addActivity({type:'share', pid, user:me.username, action:'share', ts:Date.now()});
          }
        }
        const btn = document.getElementById('copy');
        btn.textContent = 'Copied ✓';
        setTimeout(() => btn.textContent = 'Copy', 900);
      } catch (e) { alert('Copy failed.'); }
    });

    // ========= Discussion logic =========
    const sortEl = document.getElementById('sort');
    const threadEl = document.getElementById('thread');
    const noneEl = document.getElementById('none');
    const moreWrap = document.getElementById('moreWrap');
    const loadMoreBtn = document.getElementById('loadMore');

    // Pagination state for parents
    let parentShow = 5;

    function parentComments(arr){ return arr.filter(c => !c.parentId && !c.deleted); }
    function childComments(arr, pid){ return arr.filter(c => c.parentId === pid && !c.deleted); }

    function score(c, all){
      // Top: likes weigh more, replies add weight, tiny time decay
      const r = c.reactions || {};
      const likes = (r.like||0) + (r.heart||0);
      const replies = childComments(all, c.id).length;
      const ageHrs = (Date.now() - new Date(c.ts)) / 36e5;
      return likes*2 + replies*1.5 + Math.max(0, 10 - ageHrs*0.2);
    }

    function lastActive(c, all){
      const kids = childComments(all, c.id);
      const latestChild = kids.reduce((mx, k)=> Math.max(mx, new Date(k.ts).getTime()), 0);
      return Math.max(new Date(c.ts).getTime(), latestChild);
    }

    function renderComments(){
      const data = getComments()[pid] || [];
      const sort = sortEl.value; // top/new/active

      const parents = parentComments(data).slice();
      if (sort === 'new') parents.sort((a,b)=> new Date(b.ts)-new Date(a.ts));
      if (sort === 'top') parents.sort((a,b)=> score(b,data)-score(a,data));
      if (sort === 'active') parents.sort((a,b)=> lastActive(b,data)-lastActive(a,data));

      const toShow = parents.slice(0, parentShow);
      noneEl.classList.toggle('hidden', toShow.length>0);

      threadEl.innerHTML = toShow.map(p => parentHTML(p, data)).join('');
      // Bind all dynamic buttons
      bindAllActions();

      moreWrap.classList.toggle('hidden', parents.length <= parentShow);
    }

    function parentHTML(c, all){
      return `
        <article class="border border-gray-100 rounded p-3">
          ${commentHeaderHTML(c)}
          <div class="mt-1 text-sm">${mentionize(c.text||'')}</div>
          ${actionBarHTML(c)}
          <div class="pl-4 mt-3 space-y-3">
            ${childComments(all, c.id).sort((a,b)=> new Date(a.ts)-new Date(b.ts)).map(ch => childHTML(ch)).join('')}
            ${replyBoxHTML(c.id)}
          </div>
        </article>
      `;
    }

    function childHTML(c){
      return `
        <div class="border border-gray-100 rounded p-2">
          ${commentHeaderHTML(c)}
          <div class="mt-1 text-sm">${mentionize(c.text||'')}</div>
          ${actionBarHTML(c, true)}
        </div>
      `;
    }

    function commentHeaderHTML(c){
      return `
        <div class="flex items-center justify-between">
          <div class="text-xs text-gray-500"><strong class="text-gray-700">${esc(c.user)}</strong> • ${fmtTime(c.ts)}</div>
          ${c.edits?.length ? `<div class="text-[11px] text-gray-400 italic">edited</div>` : ``}
        </div>
      `;
    }

    function reactionCounts(r){
      const map = {like:'👍', heart:'❤️', idea:'💡', laugh:'😂'};
      return Object.entries(map).map(([k,emoji])=>{
        const v = (r?.[k]||0);
        return `<button class="emoji react" data-r="${k}">${emoji} <span class="text-xs">${v||''}</span></button>`;
      }).join(' ');
    }

    function actionBarHTML(c, isChild=false){
      const mine = me && me.username === c.user;
      const canEdit = mine && (Date.now() - new Date(c.ts).getTime() <= 10*60*1000); // 10 min window
      return `
        <div class="mt-2 flex items-center gap-3 text-xs">
          <div class="flex items-center gap-2">${reactionCounts(c.reactions)}</div>
          ${!isChild ? `<button class="btn reply text-indigo-600 hover:underline" data-id="${c.id}">Reply</button>` : ``}
          ${canEdit ? `<button class="btn edit text-gray-600 hover:underline" data-id="${c.id}">Edit</button>` : ``}
          ${mine ? `<button class="btn delete text-gray-500 hover:underline" data-id="${c.id}">Delete</button>` : `<button class="btn report text-gray-500 hover:underline" data-id="${c.id}">Report</button>`}
        </div>
      `;
    }

    function replyBoxHTML(parentId){
      return `
        <div class="mt-2">
          <textarea class="replyBox w-full border rounded px-3 py-2 text-sm" data-parent="${parentId}" rows="2" placeholder="Reply… (login required)"></textarea>
          <div class="mt-1 flex justify-end">
            <button class="btn sendReply bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-1.5 rounded text-xs" data-parent="${parentId}">Reply</button>
          </div>
        </div>
      `;
    }

    function bindAllActions(){
      // Reactions
      threadEl.querySelectorAll('.react').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          if (!me){ location.href='login.html?next='+encodeURIComponent(location.pathname+location.search); return; }
          const cEl = btn.closest('[data-id]') || btn.closest('article,div');
          const id = btn.closest('article,div').querySelector('.edit, .delete, .report, .reply')?.getAttribute('data-id');
          const type = btn.getAttribute('data-r'); // like/heart/idea/laugh
          toggleReaction(id, type);
        });
      });

      // Reply
      threadEl.querySelectorAll('.reply').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = b.getAttribute('data-id');
          const box = threadEl.querySelector(`.replyBox[data-parent="${id}"]`);
          box?.focus();
        });
      });
      threadEl.querySelectorAll('.sendReply').forEach(b=>{
        b.addEventListener('click', ()=>{
          const parentId = b.getAttribute('data-parent');
          const box = threadEl.querySelector(`.replyBox[data-parent="${parentId}"]`);
          const text = (box?.value||'').trim();
          if (!text) return;
          if (!me){ location.href='login.html?next='+encodeURIComponent(location.pathname+location.search); return; }
          postComment(text, parentId);
          box.value='';
          renderComments();
        });
      });

      // Edit
      threadEl.querySelectorAll('.edit').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = b.getAttribute('data-id');
          const data = getComments(); const arr = data[pid]||[];
          const idx = arr.findIndex(x=>x.id===id);
          if (idx===-1) return;
          const c = arr[idx];
          if (!me || me.username!==c.user) return;
          const now = Date.now(); if (now - new Date(c.ts).getTime() > 10*60*1000) return;
          const text = prompt('Edit your comment:', c.text||'');
          if (text===null) return;
          c.edits = c.edits || [];
          c.edits.push({ts:new Date().toISOString(), prev:c.text||''});
          c.text = text;
          arr[idx]=c; data[pid]=arr; setComments(data);
          renderComments();
        });
      });

      // Delete
      threadEl.querySelectorAll('.delete').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = b.getAttribute('data-id');
          const data = getComments(); const arr = data[pid]||[];
          const idx = arr.findIndex(x=>x.id===id);
          if (idx===-1) return;
          const c = arr[idx];
          if (!me || me.username!==c.user) return;
          if (!confirm('Delete this comment?')) return;
          c.deleted = true; arr[idx]=c; data[pid]=arr; setComments(data);
          renderComments();
        });
      });

      // Report
      threadEl.querySelectorAll('.report').forEach(b=>{
        b.addEventListener('click', ()=>{
          if (!me){ location.href='login.html?next='+encodeURIComponent(location.pathname+location.search); return; }
          const id = b.getAttribute('data-id');
          const rep = getReports(); rep[pid] = rep[pid]||{}; rep[pid][id] = rep[pid][id]||{};
          if (rep[pid][id][me.username]){ alert('Already reported.'); return; }
          rep[pid][id][me.username]=true; setReports(rep);
          // Increment counter on comment
          const data = getComments(); const arr = data[pid]||[];
          const it = arr.find(x=>x.id===id); if (it){ it.reports = (it.reports||0)+1; setComments(data); }
          alert('Reported. Thank you.');
        });
      });
    }

    function toggleReaction(commentId, type){
      const users = getUserReactions(); users[pid]=users[pid]||{}; users[pid][commentId]=users[pid][commentId]||{};
      const prev = users[pid][commentId][me.username] || null;
      const db = getComments(); const arr = db[pid]||[]; const c = arr.find(x=>x.id===commentId); if (!c) return;
      c.reactions = c.reactions || {like:0,heart:0,idea:0,laugh:0};

      if (prev === type){
        // toggle off
        c.reactions[type] = Math.max(0, (c.reactions[type]||0)-1);
        delete users[pid][commentId][me.username];
      } else {
        // switch reaction
        if (prev) c.reactions[prev] = Math.max(0, (c.reactions[prev]||0)-1);
        c.reactions[type] = (c.reactions[type]||0)+1;
        users[pid][commentId][me.username] = type;
      }

      setUserReactions(users);
      setComments(db);
      renderComments();
    }

    function postComment(text, parentId=null){
      if (!me){ location.href = 'login.html?next=' + encodeURIComponent(location.pathname + location.search); return; }
      const db = getComments(); db[pid]=db[pid]||[];
      const id = 'c-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
      const now = new Date().toISOString();
      db[pid].push({
        id, user: me.username, text, ts: now, parentId,
        reactions: {like:0,heart:0,idea:0,laugh:0}, edits: [], deleted: false, reports: 0
      });
      setComments(db);
      // Points +1 for parent, +1 for reply
      const pts = getPoints(); pts[me.username] = (pts[me.username] || 0) + 1; setPoints(pts);
      addActivity({type:'comment', pid, user:me.username, action: parentId ? 'reply' : 'comment', ts:Date.now(), meta:{parentId}});
    }

    // New parent comment
    (function setupNewComment(){
      const hint = document.getElementById('cHint');
      if (me) hint.textContent = `Logged in as ${me.username}`;
      else hint.innerHTML = `You’re not logged in. <a href="login.html?next=${encodeURIComponent(location.pathname + location.search)}" class="text-indigo-600 hover:underline">Log in</a>`;

      document.getElementById('cPost').addEventListener('click', ()=>{
        const t = document.getElementById('cText').value.trim();
        if (!t) return;
        if (!me){ location.href = 'login.html?next=' + encodeURIComponent(location.pathname + location.search); return; }
        postComment(t, null);
        document.getElementById('cText').value='';
        renderComments();
      });
    })();

    // Sort + pagination
    sortEl.addEventListener('change', ()=>{ parentShow = 5; renderComments(); });
    loadMoreBtn.addEventListener('click', ()=>{ parentShow += 5; renderComments(); });

    // ========= Init =========
    renderPoll();
    renderComments();
  </script>
</body>
</html>