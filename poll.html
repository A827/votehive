<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoteHive – Poll</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
</head>
<body class="bg-white text-gray-800 font-sans">

  <!-- Header -->
  <header class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white">
    <div class="max-w-7xl mx-auto px-4 py-6 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <img src="/logo.svg" alt="VoteHive Logo" class="w-8 h-8">
        <span class="text-xl font-bold">VoteHive</span>
      </div>
      <nav class="flex gap-4 text-sm">
        <a href="index.html" class="hover:underline">Home</a>
        <a href="trending.html" class="hover:underline">Trending Polls</a>
        <a href="browse.html" class="hover:underline">Browse Polls</a>
        <a href="my-polls.html" class="hover:underline">My Polls</a>
        <a href="rewards.html" class="hover:underline">Rewards</a>
        <a href="create.html" class="bg-white text-purple-700 px-3 py-1 rounded hover:bg-gray-200">Create Poll</a>
      </nav>
    </div>
  </header>

  <!-- Poll Content -->
  <main class="max-w-3xl mx-auto px-4 py-12">
    <h1 id="poll-title" class="text-3xl font-bold mb-2">Loading...</h1>
    <p id="poll-category" class="text-sm text-gray-500 mb-1"></p>
    <p id="countdown" class="text-sm text-indigo-600 font-semibold mb-6"></p>

    <form id="vote-form" class="space-y-3 mb-6"></form>
    <button id="submit-vote" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded">Submit Vote</button>

    <section id="results" class="mt-8 hidden">
      <h2 class="text-lg font-semibold mb-3">Results</h2>
      <div id="results-list" class="space-y-3"></div>
      <p id="total-votes" class="text-xs text-gray-500 mt-2"></p>
    </section>

    <section class="mt-10">
      <label class="block text-sm font-medium mb-1">📤 Share this poll</label>
      <div class="flex gap-2">
        <input id="share-link" type="text" class="flex-1 border px-3 py-2 rounded" readonly>
        <button id="copy-btn" class="bg-gray-100 px-3 py-2 rounded hover:bg-gray-200 text-sm">Copy</button>
      </div>
      <p id="copied-msg" class="text-green-600 text-sm mt-1 hidden">Link copied!</p>

      <div class="flex items-center gap-2 mt-4">
        <a id="share-wa" target="_blank" rel="noopener" class="inline-block bg-green-500 text-white text-sm px-3 py-2 rounded hover:bg-green-600">Share on WhatsApp</a>
        <a id="share-x"  target="_blank" rel="noopener" class="inline-block bg-black text-white text-sm px-3 py-2 rounded hover:opacity-90">Share on X</a>
      </div>
    </section>
  </main>

  <footer class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white py-6 mt-16">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
      <span>© 2025 VoteHive</span>
      <div class="flex gap-6">
        <a href="#" class="hover:underline">About</a>
        <a href="#" class="hover:underline">Contact</a>
      </div>
    </div>
  </footer>

  <div id="toast" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded shadow"></div>

  <script>
    // --- Gamification helpers ---
    function getProfile() {
      try { return JSON.parse(localStorage.getItem('vh_profile') || '{}'); } catch { return {}; }
    }
    function saveProfile(p) {
      localStorage.setItem('vh_profile', JSON.stringify(p));
    }
    function ensureProfile() {
      const p = getProfile();
      return Object.assign({
        points: 0, badges: [], streak: 0, lastActiveISO: null, createdCount: 0, votesCast: 0
      }, p);
    }
    function awardVote() {
      const p = ensureProfile();
      const today = new Date(); today.setHours(0,0,0,0);
      const lastISO = p.lastActiveISO ? new Date(p.lastActiveISO) : null;
      if (!lastISO) p.streak = 1;
      else {
        lastISO.setHours(0,0,0,0);
        const diffDays = Math.round((today - lastISO)/86400000);
        if (diffDays === 1) p.streak += 1;
        else if (diffDays > 1) p.streak = 1;
      }
      p.lastActiveISO = new Date().toISOString();

      p.points += 2;        // voting points
      p.points += 5;        // daily active bonus
      p.votesCast += 1;

      if (p.votesCast === 50 && !p.badges.includes('50 Votes Cast')) p.badges.push('50 Votes Cast');
      if (p.points >= 50 && !p.badges.includes('Rising')) p.badges.push('Rising');
      if (p.points >= 150 && !p.badges.includes('Influencer')) p.badges.push('Influencer');
      if (p.points >= 500 && !p.badges.includes('Hive Master')) p.badges.push('Hive Master');

      saveProfile(p);
      return p;
    }

    // --- Existing poll page logic ---
    const builtinPolls = {
      "startup-vs-enterprise": {
        title: "Which is better: Startup or Enterprise job?",
        category: "Careers",
        options: ["Startup", "Enterprise"],
        endTime: new Date(Date.now() + 2*24*60*60*1000).toISOString()
      },
      "ai-future": {
        title: "Will AI create more jobs than it eliminates?",
        category: "Technology",
        options: ["Yes", "No", "Not Sure"],
        endTime: new Date(Date.now() + 24*60*60*1000).toISOString()
      },
      "real-estate-safe": {
        title: "Which property investment is safer?",
        category: "Real Estate",
        options: ["Apartments", "Villas", "Commercial"],
        endTime: new Date(Date.now() + 3*24*60*60*1000).toISOString()
      },
      "flat-vs-skeuo": {
        title: "Which UI design style do you prefer?",
        category: "Design",
        options: ["Flat Design", "Skeuomorphic Design"],
        endTime: new Date(Date.now() + 2*24*60*60*1000).toISOString()
      },
      "global-online-vote": {
        title: "Should national elections support online voting globally?",
        category: "Global",
        options: ["Yes, it's time", "No, too risky", "Maybe in the future"],
        endTime: new Date(Date.now() + 4*24*60*60*1000).toISOString()
      }
    };

    const titleEl = document.getElementById("poll-title");
    const categoryEl = document.getElementById("poll-category");
    const formEl = document.getElementById("vote-form");
    const submitBtn = document.getElementById("submit-vote");
    const countdownEl = document.getElementById("countdown");
    const resultsWrap = document.getElementById("results");
    const resultsList = document.getElementById("results-list");
    const totalVotesEl = document.getElementById("total-votes");
    const shareInput = document.getElementById("share-link");
    const copyBtn = document.getElementById("copy-btn");
    const copiedMsg = document.getElementById("copied-msg");
    const shareWA = document.getElementById("share-wa");
    const shareX = document.getElementById("share-x");
    const toast = document.getElementById("toast");

    const getCustomPolls = () => JSON.parse(localStorage.getItem("customPolls") || "{}");
    const getAllVotes = () => JSON.parse(localStorage.getItem("pollVotes") || "{}");
    const setAllVotes = (v) => localStorage.setItem("pollVotes", JSON.stringify(v));

    const params = new URLSearchParams(location.search);
    const pollId = params.get("id") || "";
    const poll = getCustomPolls()[pollId] || builtinPolls[pollId];

    if (!poll) {
      titleEl.textContent = "Poll not found.";
      formEl.innerHTML = "";
      submitBtn.style.display = "none";
    } else {
      titleEl.textContent = poll.title || "Untitled poll";
      categoryEl.textContent = poll.category ? `Category: ${poll.category}` : "";
      const shareUrl = `${location.origin}${location.pathname}?id=${encodeURIComponent(pollId)}`;
      shareInput.value = shareUrl;
      shareWA.href = `https://wa.me/?text=${encodeURIComponent(poll.title + " — " + shareUrl)}`;
      shareX.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(poll.title)}&url=${encodeURIComponent(shareUrl)}`;

      formEl.innerHTML = "";
      (poll.options || []).forEach((opt, i) => {
        const id = `opt-${i}`;
        formEl.insertAdjacentHTML("beforeend", `
          <label for="${id}" class="block border border-gray-300 rounded p-2 cursor-pointer hover:bg-gray-50">
            <input id="${id}" type="radio" name="vote" value="${opt}" class="mr-2">${opt}
          </label>
        `);
      });

      const end = new Date(poll.endTime);
      function updateCountdown() {
        const diff = end - new Date();
        if (isNaN(diff)) { countdownEl.textContent = ""; return; }
        if (diff <= 0) {
          countdownEl.textContent = "⏱️ Poll Closed";
          submitBtn.disabled = true;
          formEl.querySelectorAll("input[type=radio]").forEach(i => i.disabled = true);
          renderResults();
          return;
        }
        const d = Math.floor(diff/86400000);
        const h = Math.floor((diff/3600000)%24);
        const m = Math.floor((diff/60000)%60);
        countdownEl.textContent = `⏳ Closes in ${d}d ${h}h ${m}m`;
      }
      updateCountdown();
      setInterval(updateCountdown, 60000);

      function currentVotes() {
        const all = getAllVotes();
        return all[pollId] || {};
      }
      function saveVotes(v) {
        const all = getAllVotes();
        all[pollId] = v;
        setAllVotes(all);
      }
      function castVote(option) {
        const v = currentVotes();
        v[option] = (v[option] || 0) + 1;
        saveVotes(v);
      }
      function totalVotes(v) {
        return Object.values(v).reduce((a,b)=>a+b,0);
      }
      function renderResults() {
        const v = currentVotes();
        const t = totalVotes(v);
        resultsList.innerHTML = "";
        (poll.options || []).forEach(opt => {
          const count = v[opt] || 0;
          const pct = t ? Math.round((count/t)*100) : 0;
          resultsList.insertAdjacentHTML("beforeend", `
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span>${opt}</span><span>${pct}% (${count})</span>
              </div>
              <div class="w-full h-2 bg-gray-200 rounded">
                <div class="h-2 bg-indigo-600 rounded" style="width:${pct}%"></div>
              </div>
            </div>
          `);
        });
        totalVotesEl.textContent = `Total votes: ${t}`;
        resultsWrap.classList.remove("hidden");
      }
      renderResults();

      submitBtn.addEventListener("click", (e) => {
        e.preventDefault();
        if (new Date() > end) { updateCountdown(); return; }
        const chosen = document.querySelector('input[name="vote"]:checked');
        if (!chosen) { alert("Please select an option."); return; }
        castVote(chosen.value);
        renderResults();

        // Award on vote
        const p = awardVote();
        toast.textContent = `Thanks for voting! (+2 pts, +5 daily bonus). Total: ${p.points} pts`;
        toast.classList.remove('hidden');
        setTimeout(()=>toast.classList.add('hidden'), 1500);
      });
    }

    // Copy share
    document.getElementById("copy-btn").addEventListener("click", (e) => {
      e.preventDefault();
      const input = document.getElementById("share-link");
      input.select(); document.execCommand("copy");
      const msg = document.getElementById("copied-msg");
      msg.classList.remove("hidden");
      setTimeout(()=>msg.classList.add("hidden"), 1500);
    });
  </script>
</body>
</html>