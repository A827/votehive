<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Poll – VoteHive</title>
  <link rel="icon" href="/favicon.ico"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    .pill{padding:4px 10px;border-radius:9999px;font-size:12px;display:inline-block}
    .countdown{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="bg-white text-gray-800 font-sans">

  <!-- Header mount (required) -->
  <div id="vh-header"></div>
  <!-- Keep your existing auth helpers -->
  <script src="guard.js"></script>
  <!-- Your existing role-aware header -->
  <script src="header.js"></script>

  <main class="max-w-5xl mx-auto px-4 py-8">
    <a href="browse.html" class="text-sm text-indigo-600 hover:underline">← Back to Browse</a>

    <div id="wrap" class="mt-4 bg-white border border-gray-100 shadow rounded p-5">
      <h1 id="title" class="text-2xl font-bold mb-1">Loading…</h1>
      <div class="flex flex-wrap items-center gap-2 text-sm text-gray-600">
        <span id="cat" class="pill bg-gray-100 text-gray-700">General</span>
        <span id="state" class="pill">Open</span>
        <span id="ends" class="pill bg-indigo-100 text-indigo-700 countdown">Ends —</span>
      </div>

      <div id="desc" class="mt-4 text-gray-700 hidden"></div>

      <section class="mt-6">
        <h2 class="text-lg font-semibold mb-3">Vote</h2>
        <div id="opts" class="grid gap-2"></div>
        <div id="note" class="mt-2 text-xs text-gray-500"></div>
      </section>

      <section class="mt-8">
        <h3 class="text-lg font-semibold mb-2">Share</h3>
        <div class="flex gap-2">
          <input id="link" class="border rounded px-3 py-2 w-full text-sm" readonly/>
          <button id="copy" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded text-sm">Copy</button>
        </div>
        <p class="text-xs text-gray-500 mt-1">Share this link to invite votes. (Logged-in users earn +1 point for sharing.)</p>
      </section>

      <section class="mt-8">
        <h3 class="text-lg font-semibold mb-2">Comments</h3>
        <div id="commentForm" class="mb-3">
          <textarea id="cText" rows="3" class="w-full border rounded px-3 py-2 text-sm" placeholder="Add a comment… (login required)"></textarea>
          <div class="mt-2 flex items-center justify-between">
            <span id="cHint" class="text-xs text-gray-500">You’re not logged in.</span>
            <button id="cPost" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-sm">Post</button>
          </div>
        </div>
        <div id="comments" class="space-y-3"></div>
        <div id="noComments" class="text-sm text-gray-500">No comments yet.</div>
      </section>
    </div>
  </main>

  <footer class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white py-8 mt-12">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
      <span>© 2025 VoteHive</span>
      <div class="flex gap-6"><a href="#" class="hover:underline">About</a><a href="#" class="hover:underline">Contact</a></div>
    </div>
  </footer>

  <script>
    // --- Helpers: storage + auth ---
    const pid = new URLSearchParams(location.search).get('id');
    const getPolls = () => JSON.parse(localStorage.getItem('customPolls') || '{}');
    const setPolls = (d) => localStorage.setItem('customPolls', JSON.stringify(d));

    const getVotes = () => JSON.parse(localStorage.getItem('pollVotes') || '{}');
    const setVotes = (d) => localStorage.setItem('pollVotes', JSON.stringify(d));

    const getUserVotes = () => JSON.parse(localStorage.getItem('userVotes') || '{}'); // { [pid]: { [username]: optionIndex } }
    const setUserVotes = (d) => localStorage.setItem('userVotes', JSON.stringify(d));

    const getComments = () => JSON.parse(localStorage.getItem('pollComments') || '{}'); // { [pid]: [{user, text, ts}] }
    const setComments = (d) => localStorage.setItem('pollComments', JSON.stringify(d));

    const getPoints = () => JSON.parse(localStorage.getItem('userPoints') || '{}'); // { [username]: points }
    const setPoints = (d) => localStorage.setItem('userPoints', JSON.stringify(d));

    const getEarned = () => JSON.parse(localStorage.getItem('vh_pointsEarned') || '{}'); // { "vote:USER:PID": ts, "share:USER:PID": ts }
    const setEarned = (d) => localStorage.setItem('vh_pointsEarned', JSON.stringify(d));

    const me = (window.VHAuth?.current?.() || null);

    // --- Render poll ---
    function fmtCountdown(end) {
      const ms = end - new Date();
      if (ms <= 0) return 'Closed';
      const s = Math.floor(ms/1000);
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      const ss= s % 60;
      return `${d}d ${h}h ${m}m ${ss}s`;
    }

    function render() {
      const polls = getPolls();
      const p = polls[pid];
      const titleEl = document.getElementById('title');
      const catEl   = document.getElementById('cat');
      const stateEl = document.getElementById('state');
      const endsEl  = document.getElementById('ends');
      const optsEl  = document.getElementById('opts');
      const noteEl  = document.getElementById('note');
      const linkEl  = document.getElementById('link');

      if (!p) {
        titleEl.textContent = 'Poll not found';
        document.getElementById('wrap').classList.add('opacity-70');
        document.getElementById('opts').innerHTML = '<div class="text-sm text-gray-500">No options available.</div>';
        return;
      }

      const end = new Date(p.endTime);
      const closed = isNaN(end) ? false : (Date.now() > end.getTime());

      titleEl.textContent = p.title || 'Untitled poll';
      catEl.textContent = p.category || 'General';
      stateEl.textContent = closed ? 'Closed' : 'Open';
      stateEl.className = 'pill ' + (closed ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700');
      endsEl.textContent = (isNaN(end) ? 'Ends: N/A' : 'Ends: ' + end.toLocaleString());

      // Live countdown (if end valid)
      if (!isNaN(end)) {
        const upd = () => { endsEl.textContent = 'Ends: ' + fmtCountdown(end); };
        upd();
        setInterval(upd, 1000);
      }

      // Voting UI
      const votes = getVotes();
      const userVotes = getUserVotes();
      const myVote = (me && userVotes[pid] && userVotes[pid][me.username] !== undefined)
        ? userVotes[pid][me.username] : null;

      const counts = votes[pid] || {}; // { "0": 10, "1": 3, ... }
      const total = (p.options || []).reduce((acc, _, i) => acc + (counts[i] || 0), 0);

      optsEl.innerHTML = (p.options || []).map((opt, i) => {
        const c = counts[i] || 0;
        const pct = total ? Math.round((c / total) * 100) : 0;
        const isMine = myVote === i;
        return `
          <button data-idx="${i}" class="group w-full text-left border rounded px-3 py-3 hover:bg-gray-50 ${isMine?'border-indigo-300 bg-indigo-50':''}" ${closed?'disabled':''}>
            <div class="flex items-center justify-between">
              <span class="font-medium">${opt.replace(/</g,'&lt;')}</span>
              <span class="text-sm text-gray-500">${c} • ${pct}%</span>
            </div>
            <div class="h-2 mt-2 rounded bg-gray-100">
              <div class="h-2 rounded ${isMine?'bg-indigo-500':'bg-indigo-300'}" style="width:${pct}%;"></div>
            </div>
          </button>`;
      }).join('');

      if (closed) {
        noteEl.textContent = 'This poll is closed. Voting is disabled.';
      } else if (!me) {
        noteEl.innerHTML = 'Log in to vote. <a class="text-indigo-600 hover:underline" href="login.html?next=' + encodeURIComponent(location.pathname + location.search) + '">Log in</a>';
      } else if (myVote !== null) {
        noteEl.textContent = `You voted for option #${myVote + 1}.`;
      } else {
        noteEl.textContent = 'One vote per user.';
      }

      // Bind votes
      optsEl.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.addEventListener('click', () => {
          if (closed) return;
          if (!me) { location.href = 'login.html?next=' + encodeURIComponent(location.pathname + location.search); return; }
          const idx = Number(btn.getAttribute('data-idx'));
          // Prevent double vote
          const uv = getUserVotes();
          if (!uv[pid]) uv[pid] = {};
          if (uv[pid][me.username] !== undefined) { render(); return; }

          const vv = getVotes();
          if (!vv[pid]) vv[pid] = {};
          vv[pid][idx] = (vv[pid][idx] || 0) + 1;
          setVotes(vv);

          uv[pid][me.username] = idx;
          setUserVotes(uv);

          // Points +2 for vote
          const pts = getPoints(); pts[me.username] = (pts[me.username] || 0) + 2; setPoints(pts);
          const earned = getEarned(); earned[`vote:${me.username}:${pid}`] = new Date().toISOString(); setEarned(earned);

          render();
        });
      });

      // Share link
      linkEl.value = location.origin + location.pathname + '?id=' + encodeURIComponent(pid);
    }

    // Copy button + share points
    document.getElementById('copy').addEventListener('click', async () => {
      const link = document.getElementById('link').value;
      try {
        await navigator.clipboard.writeText(link);
        // Award share point if logged in and not awarded yet for this poll
        if (me) {
          const earned = getEarned();
          const key = `share:${me.username}:${pid}`;
          if (!earned[key]) {
            earned[key] = new Date().toISOString();
            setEarned(earned);
            const pts = getPoints(); pts[me.username] = (pts[me.username] || 0) + 1; setPoints(pts);
          }
        }
        document.getElementById('copy').textContent = 'Copied ✓';
        setTimeout(() => document.getElementById('copy').textContent = 'Copy', 900);
      } catch (e) {
        alert('Copy failed. You can manually copy the link.');
      }
    });

    // Comments
    function renderComments(){
      const box = document.getElementById('comments');
      const empty = document.getElementById('noComments');
      const data = getComments()[pid] || [];
      if (!data.length){ box.innerHTML=''; empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      box.innerHTML = data.slice(-50).reverse().map(c => `
        <article class="bg-white border border-gray-100 rounded p-3">
          <div class="text-xs text-gray-500">${c.user} • ${new Date(c.ts).toLocaleString()}</div>
          <div class="text-sm mt-1">${(c.text||'').replace(/</g,'&lt;')}</div>
        </article>
      `).join('');
    }

    document.getElementById('cPost').addEventListener('click', ()=>{
      const t = document.getElementById('cText').value.trim();
      const hint = document.getElementById('cHint');
      if (!me){ location.href = 'login.html?next=' + encodeURIComponent(location.pathname + location.search); return; }
      if (!t) return;
      const all = getComments();
      if (!all[pid]) all[pid] = [];
      all[pid].push({ user: me.username, text: t, ts: new Date().toISOString() });
      setComments(all);
      document.getElementById('cText').value = '';
      // Points +1 for comment
      const pts = getPoints(); pts[me.username] = (pts[me.username] || 0) + 1; setPoints(pts);
      const earned = getEarned(); earned[`comment:${me.username}:${pid}`] = new Date().toISOString(); setEarned(earned);
      renderComments();
    });

    // Comment hint
    (function(){
      const hint = document.getElementById('cHint');
      if (me) hint.textContent = `Logged in as ${me.username}`;
      else hint.innerHTML = `You’re not logged in. <a href="login.html?next=${encodeURIComponent(location.pathname + location.search)}" class="text-indigo-600 hover:underline">Log in</a>`;
    })();

    // Init
    render();
    renderComments();
  </script>
</body>
</html>