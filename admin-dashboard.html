<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin Dashboard – VoteHive</title>
  <link rel="icon" href="/favicon.ico"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    html.vh-dark body { background-color:#0f172a; color:#e5e7eb; }
    .vh-card { background:#fff; transition: box-shadow .2s ease, transform .06s ease; }
    html.vh-dark .vh-card { background:#111827; border-color:#1f2937; }
    .vh-card:hover { box-shadow: 0 8px 30px rgba(0,0,0,.06); }
    .vh-btn { background:#f3f4f6; }
    .vh-btn:hover { background:#e5e7eb; }
    .vh-cta { background:#4f46e5; color:#fff; }
    .vh-cta:hover { background:#4338ca; }
    .vh-link { color:#4f46e5; }
    .vh-link:hover { text-decoration: underline; }
    .vh-input { background:#fff; }
    html.vh-dark .vh-input { background:#0b1222; color:#e5e7eb; border-color:#334155; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- Shared header (role-aware) -->
  <div id="vh-header"></div>
  <!-- LOAD ORDER MATTERS -->
  <script src="auth.js"></script>
  <script src="guard.js"></script>
  <script src="header.js"></script>
  <script>
    // Admin-only guard (admin OR superadmin)
    if (typeof requireAdmin === 'function') { requireAdmin(); }

    // Simple theme toggle (no external theme.js)
    (function initTheme(){
      var t = localStorage.getItem('vh_theme') || 'light';
      document.documentElement.classList.toggle('vh-dark', t === 'dark');
      window.toggleTheme = function(){
        var dark = !document.documentElement.classList.contains('vh-dark');
        document.documentElement.classList.toggle('vh-dark', dark);
        localStorage.setItem('vh_theme', dark ? 'dark' : 'light');
      };
    })();
  </script>

  <main class="max-w-7xl mx-auto px-4 py-8">
    <div class="flex items-start justify-between gap-6 flex-wrap">
      <h1 class="text-3xl font-bold">Admin Dashboard</h1>
      <div class="flex items-center gap-2">
        <a href="applications.html" class="vh-link text-sm">Applications</a>
        <span class="text-gray-400">•</span>
        <a href="moderation.html" class="vh-link text-sm">Moderation</a>
        <span class="text-gray-400">•</span>
        <button onclick="toggleTheme()" class="vh-btn px-3 py-1 rounded text-sm">Toggle Theme</button>
      </div>
    </div>

    <p class="text-sm text-gray-600 mt-1">Review applications → publish polls → manage visibility.</p>

    <!-- Pending applications -->
    <section class="vh-card border border-gray-100 shadow rounded p-6 mb-8 mt-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Pending Applications</h2>
        <span class="text-sm text-gray-500" id="pendingHint"></span>
      </div>
      <div id="pendingList" class="divide-y"></div>
    </section>

    <!-- Existing polls quick view -->
    <section class="vh-card border border-gray-100 shadow rounded p-6">
      <div class="flex items-center justify-between mb-3 gap-3 flex-wrap">
        <h2 class="text-xl font-semibold">Published Polls</h2>
        <div class="flex items-center gap-2">
          <input id="search" type="text" placeholder="Search title…" class="vh-input border rounded px-3 py-2 w-72">
          <a href="moderation.html" class="vh-link text-sm">Go to Moderation →</a>
        </div>
      </div>
      <div id="pollList" class="divide-y"></div>
    </section>
  </main>

  <footer class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white py-6 mt-16">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
      <span>© 2025 VoteHive</span>
      <div class="flex gap-6">
        <a href="#" class="hover:underline">About</a>
        <a href="#" class="hover:underline">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    // ----- Storage helpers (shared keys) -----
    function safeParse(json, fallback){
      try { return JSON.parse(json); } catch(e){ return fallback; }
    }
    var getPolls   = function(){ return safeParse(localStorage.getItem('customPolls') || '{}', {}); };
    var setPolls   = function(d){ localStorage.setItem('customPolls', JSON.stringify(d)); };
    var getLog     = function(){ return safeParse(localStorage.getItem('applicationLog') || '[]', []); };
    var setLog     = function(d){ localStorage.setItem('applicationLog', JSON.stringify(d)); };

    // Legacy/optional pending store
    var getPendingObj = function(){ return safeParse(localStorage.getItem('pendingPolls') || '{}', {}); };
    var setPendingObj = function(d){ localStorage.setItem('pendingPolls', JSON.stringify(d)); };

    var getPoints  = function(){ return safeParse(localStorage.getItem('userPoints') || '{}', {}); };
    var setPoints  = function(d){ localStorage.setItem('userPoints', JSON.stringify(d)); };
    var getEarned  = function(){ return safeParse(localStorage.getItem('vh_pointsEarned') || '{}', {}); };
    var setEarned  = function(d){ localStorage.setItem('vh_pointsEarned', JSON.stringify(d)); };

    function awardOnce(key, username, amount){
      var earned = getEarned();
      if (earned[key]) return false;
      var pts = getPoints();
      pts[username] = (pts[username]||0) + amount;
      setPoints(pts);
      earned[key] = true;
      setEarned(earned);
      return true;
    }

    // ----- Pending applications (merge sources) -----
    function getPendingMerged(){
      var out = [];
      // Source A: applicationLog entries with status "pending"
      var log = getLog();
      log.filter(function(x){ return x && x.status === 'pending'; }).forEach(function(x){
        out.push({
          pid: x.id || ('app-' + Math.random().toString(36).slice(2)),
          title: x.title,
          category: x.category,
          options: x.options || [],
          requestedDays: x.requestedDays || 7,
          submittedAt: x.createdAt || x.submittedAt || new Date().toISOString(),
          applicant: x.applicant || x.user || 'guest',
          context: x.reason || x.context || ''
        });
      });

      // Source B: pendingPolls object (if present)
      var pendObj = getPendingObj();
      Object.keys(pendObj).forEach(function(pid){
        var p = pendObj[pid] || {};
        out.push({
          pid: pid,
          title: p.title,
          category: p.category,
          options: p.options || [],
          requestedDays: p.requestedDays || 7,
          submittedAt: p.submittedAt || p.createdAt || new Date().toISOString(),
          applicant: p.applicant || 'guest',
          context: p.context || ''
        });
      });

      // Deduplicate by (title+applicant+submittedAt)
      var seen = {};
      var unique = [];
      out.forEach(function(item){
        var key = (item.title||'')+'|'+(item.applicant||'')+'|'+(item.submittedAt||'');
        if (!seen[key]) { seen[key] = 1; unique.push(item); }
      });

      // Sort newest first
      unique.sort(function(a,b){ return new Date(b.submittedAt) - new Date(a.submittedAt); });
      return unique;
    }

    function renderPending(){
      var el = document.getElementById('pendingList');
      var items = getPendingMerged();
      var hint = document.getElementById('pendingHint');
      if (hint) hint.textContent = items.length ? '' : 'No applications pending.';
      el.innerHTML = '';

      items.forEach(function(p){
        var card = document.createElement('div');
        card.className = 'py-4';
        card.innerHTML =
          '<div class="flex items-start justify-between gap-4">'+
            '<div class="flex-1">'+
              '<div class="text-sm text-gray-500">Applicant: <strong>'+(p.applicant || 'guest')+
              '</strong> • Submitted: '+ new Date(p.submittedAt).toLocaleString() +'</div>'+
              '<div class="font-semibold mt-1">'+(p.title||'')+'</div>'+
              '<div class="text-sm text-gray-600 mt-1">Category: '+(p.category || 'General')+
              ' • Requested: '+(p.requestedDays || 7)+' days</div>'+
              '<div class="text-sm text-gray-600 mt-1">Options: '+((p.options||[]).join(', '))+'</div>'+
              (p.context ? '<div class="text-sm text-gray-500 mt-2">'+p.context+'</div>' : '')+
            '</div>'+
            '<div class="w-64 shrink-0 space-y-2">'+
              '<label class="block text-sm font-medium">Approve with duration</label>'+
              '<select data-key="'+encodeURIComponent(p.pid)+'" class="dur vh-input border rounded px-2 py-1 w-full">'+
                '<option value="1">1 day</option>'+
                '<option value="3">3 days</option>'+
                '<option value="7" selected>7 days</option>'+
                '<option value="30">30 days</option>'+
              '</select>'+
              '<div class="flex gap-2">'+
                '<button data-key="'+encodeURIComponent(p.pid)+'" class="approve vh-cta px-3 py-1 rounded text-sm">Approve</button>'+
                '<button data-key="'+encodeURIComponent(p.pid)+'" class="reject vh-btn px-3 py-1 rounded text-sm">Reject</button>'+
              '</div>'+
            '</div>'+
          '</div>';
        el.appendChild(card);
      });

      // Bind actions
      Array.prototype.forEach.call(el.querySelectorAll('.approve'), function(btn){
        btn.addEventListener('click', function(){
          var keyAttr = btn.getAttribute('data-key');
          var key = keyAttr ? decodeURIComponent(keyAttr) : '';
          var sel = el.querySelector('.dur[data-key="'+keyAttr+'"]');
          var days = parseInt((sel && sel.value) ? sel.value : '7', 10);
          approveApp(key, days);
        });
      });
      Array.prototype.forEach.call(el.querySelectorAll('.reject'), function(btn){
        btn.addEventListener('click', function(){
          var keyAttr = btn.getAttribute('data-key');
          var key = keyAttr ? decodeURIComponent(keyAttr) : '';
          if (!confirm('Reject this application?')) return;
          rejectApp(key);
        });
      });
    }

    function findAndRemovePendingByKey(key){
      // Remove from pendingPolls if present
      var pend = getPendingObj();
      if (pend[key]) { delete pend[key]; setPendingObj(pend); }

      // Try to locate in applicationLog by id
      var log = getLog();
      var idx = -1;
      for (var i=0;i<log.length;i++){
        var x = log[i];
        if (!x) continue;
        var idEnc = encodeURIComponent(x.id || '');
        if (x.id === key || idEnc === encodeURIComponent(key)) { idx = i; break; }
      }
      return { log: log, idx: idx };
    }

    function approveApp(key, days){
      var items = getPendingMerged();
      var app = null;
      for (var i=0;i<items.length;i++){ if (items[i].pid === key){ app = items[i]; break; } }
      if (!app){ alert('Application not found.'); renderAll(); return; }

      // unique poll id from title
      var base = (app.title || 'poll').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      var id = base || ('poll-' + Date.now());
      var polls = getPolls();
      if (polls[id]) id = id + '-' + Date.now();

      var nowIso = new Date().toISOString();
      var endTime = new Date(Date.now() + (days || 7)*24*60*60*1000).toISOString();
      polls[id] = {
        title: app.title,
        category: app.category,
        options: app.options,
        endTime: endTime,
        createdAt: nowIso,
        createdBy: app.applicant || 'guest',
        featured: false,
        hidden: false
      };
      setPolls(polls);

      // log decision & award
      var res = findAndRemovePendingByKey(key);
      var log = res.log, idx = res.idx;
      if (idx >= 0) {
        var entry = log[idx];
        for (var k in entry){} // keep reference
        log[idx] = {
          id: entry.id,
          status: 'approved',
          title: entry.title || app.title,
          category: entry.category || app.category,
          applicant: entry.applicant || app.applicant || 'guest',
          decidedAt: nowIso,
          pollId: id
        };
      } else {
        log.push({ id:key, status:'approved', title:app.title, category:app.category, applicant:app.applicant||'guest', decidedAt: nowIso, pollId:id });
      }
      setLog(log);

      var applicant = app.applicant || 'guest';
      awardOnce('approval:'+applicant+':'+id, applicant, 10);

      alert('Approved and published! ✅ (+10 points to applicant)');
      renderAll();
    }

    function rejectApp(key){
      var items = getPendingMerged();
      var app = null;
      for (var i=0;i<items.length;i++){ if (items[i].pid === key){ app = items[i]; break; } }
      var nowIso = new Date().toISOString();

      var pend = getPendingObj();
      if (pend[key]) { delete pend[key]; setPendingObj(pend); }

      var log = getLog();
      var idx = -1;
      for (var j=0;j<log.length;j++){
        var x = log[j];
        if (!x) continue;
        var idEnc = encodeURIComponent(x.id || '');
        if (x.id === key || idEnc === encodeURIComponent(key)) { idx = j; break; }
      }
      if (idx >= 0) {
        var e = log[idx];
        log[idx] = {
          id: e.id,
          status: 'rejected',
          title: e.title || (app ? app.title : undefined),
          category: e.category || (app ? app.category : undefined),
          applicant: e.applicant || (app ? (app.applicant||'guest') : 'guest'),
          decidedAt: nowIso
        };
      } else {
        log.push({
          id:key,
          status:'rejected',
          title: app ? app.title : undefined,
          category: app ? app.category : undefined,
          applicant: app ? (app.applicant||'guest') : 'guest',
          decidedAt: nowIso
        });
      }
      setLog(log);

      renderAll();
    }

    // ----- Published polls list -----
    function renderPolls(){
      var list = document.getElementById('pollList');
      var qEl = document.getElementById('search');
      var q = (qEl && qEl.value ? qEl.value : '').toLowerCase();

      var pollsArr = [];
      var pollsObj = getPolls();
      for (var id in pollsObj){
        if (!pollsObj.hasOwnProperty(id)) continue;
        var p = pollsObj[id];
        if (!p) continue;
        if (!q || String(p.title||'').toLowerCase().indexOf(q) !== -1){
          pollsArr.push([id, p]);
        }
      }
      pollsArr.sort(function(a,b){ return new Date(a[1].endTime) - new Date(b[1].endTime); });

      list.innerHTML = pollsArr.length ? '' : '<div class="py-4 text-sm text-gray-600">No polls found.</div>';
      pollsArr.forEach(function(pair){
        var id = pair[0], p = pair[1];
        var end = new Date(p.endTime);
        var closed = Date.now() > end.getTime();
        var row = document.createElement('div');
        row.className = 'py-4';
        row.innerHTML =
          '<div class="flex items-start justify-between gap-4">'+
            '<div>'+
              '<div class="flex items-center gap-2">'+
                '<span class="px-2 py-0.5 rounded-full text-xs '+(closed?'bg-red-100 text-red-700':'bg-green-100 text-green-700')+'">'+(closed?'Closed':'Open')+'</span>'+
                '<span class="text-xs text-gray-500">'+(p.category||'General')+'</span>'+
                (p.featured?'<span class="px-2 py-0.5 rounded-full text-xs bg-yellow-100 text-yellow-700">Featured</span>':'')+
                (p.hidden?'<span class="px-2 py-0.5 rounded-full text-xs bg-gray-200 text-gray-700">Hidden</span>':'')+
              '</div>'+
              '<div class="font-semibold mt-1">'+(p.title||'')+'</div>'+
              '<div class="text-xs text-gray-500">Ends: '+(isNaN(end)?'N/A':end.toLocaleString())+'</div>'+
              '<div class="text-xs text-gray-500">By: '+(p.createdBy||'—')+'</div>'+
            '</div>'+
            '<div class="flex flex-col gap-2">'+
              '<a href="poll.html?id='+encodeURIComponent(id)+'" target="_blank" class="vh-btn px-3 py-1 rounded text-sm text-center">Open</a>'+
              '<button data-id="'+id+'" class="feature vh-btn px-3 py-1 rounded text-sm">'+(p.featured?'Unfeature':'Feature')+'</button>'+
              '<button data-id="'+id+'" class="hide vh-btn px-3 py-1 rounded text-sm">'+(p.hidden?'Unhide':'Hide')+'</button>'+
              '<div class="flex gap-2">'+
                '<button data-id="'+id+'" class="extend vh-btn px-3 py-1 rounded text-sm">+7d</button>'+
                '<button data-id="'+id+'" class="closeNow vh-btn px-3 py-1 rounded text-sm">Close Now</button>'+
              '</div>'+
              '<button data-id="'+id+'" class="delete vh-btn px-3 py-1 rounded text-sm">Delete</button>'+
            '</div>'+
          '</div>';
        list.appendChild(row);
      });

      // actions
      Array.prototype.forEach.call(list.querySelectorAll('.feature'), function(b){
        b.addEventListener('click', function(){
          var id = b.getAttribute('data-id'); var polls = getPolls();
          if (!polls[id]) return;
          polls[id].featured = !polls[id].featured; setPolls(polls); renderPolls();
        });
      });
      Array.prototype.forEach.call(list.querySelectorAll('.hide'), function(b){
        b.addEventListener('click', function(){
          var id = b.getAttribute('data-id'); var polls = getPolls();
          if (!polls[id]) return;
          polls[id].hidden = !polls[id].hidden; setPolls(polls); renderPolls();
        });
      });
      Array.prototype.forEach.call(list.querySelectorAll('.closeNow'), function(b){
        b.addEventListener('click', function(){
          var id = b.getAttribute('data-id'); var polls = getPolls();
          if (!polls[id]) return;
          polls[id].endTime = new Date(Date.now()-1000).toISOString(); setPolls(polls); renderPolls();
        });
      });
      Array.prototype.forEach.call(list.querySelectorAll('.extend'), function(b){
        b.addEventListener('click', function(){
          var id = b.getAttribute('data-id'); var polls = getPolls();
          if (!polls[id]) return;
          var cur = new Date(polls[id].endTime || Date.now());
          polls[id].endTime = new Date(cur.getTime()+7*24*60*60*1000).toISOString(); setPolls(polls); renderPolls();
        });
      });
      Array.prototype.forEach.call(list.querySelectorAll('.delete'), function(b){
        b.addEventListener('click', function(){
          var id = b.getAttribute('data-id'); if(!confirm('Delete this poll?')) return;
          var polls = getPolls(); delete polls[id]; setPolls(polls); renderPolls();
        });
      });
    }

    var searchEl = document.getElementById('search');
    if (searchEl) searchEl.addEventListener('input', renderPolls);

    function renderAll(){ renderPending(); renderPolls(); }
    renderAll();
  </script>
</body>
</html>