<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin Dashboard – VoteHive</title>
  <link rel="icon" href="/favicon.ico"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    html.vh-dark body { background-color:#0f172a; color:#e5e7eb; }
    .vh-card { background:#fff; transition: box-shadow .2s ease, transform .06s ease; }
    html.vh-dark .vh-card { background:#111827; border-color:#1f2937; }
    .vh-card:hover { box-shadow: 0 8px 30px rgba(0,0,0,.06); }
    .vh-btn { background:#f3f4f6; }
    .vh-btn:hover { background:#e5e7eb; }
    .vh-cta { background:#4f46e5; color:#fff; }
    .vh-cta:hover { background:#4338ca; }
    .vh-link { color:#4f46e5; }
    .vh-link:hover { text-decoration: underline; }
    .vh-input { background:#fff; }
    html.vh-dark .vh-input { background:#0b1222; color:#e5e7eb; border-color:#334155; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- Shared header (role-aware) -->
  <div id="vh-header"></div>
  <script src="auth.js"></script>
  <script src="guard.js"></script>
  <script src="header.js"></script>
  <script>
    // Admin-only guard (uses our shared guard)
    requireAdmin();
    // Simple theme toggle (no external theme.js)
    (function initTheme(){
      const t = localStorage.getItem('vh_theme') || 'light';
      document.documentElement.classList.toggle('vh-dark', t === 'dark');
      window.toggleTheme = function(){
        const dark = !document.documentElement.classList.contains('vh-dark');
        document.documentElement.classList.toggle('vh-dark', dark);
        localStorage.setItem('vh_theme', dark ? 'dark' : 'light');
      }
    })();
  </script>

  <main class="max-w-7xl mx-auto px-4 py-8">
    <div class="flex items-start justify-between gap-6 flex-wrap">
      <h1 class="text-3xl font-bold">Admin Dashboard</h1>
      <div class="flex items-center gap-2">
        <a href="applications.html" class="vh-link text-sm">Applications</a>
        <span class="text-gray-400">•</span>
        <a href="moderation.html" class="vh-link text-sm">Moderation</a>
        <span class="text-gray-400">•</span>
        <button onclick="toggleTheme()" class="vh-btn px-3 py-1 rounded text-sm">Toggle Theme</button>
      </div>
    </div>

    <p class="text-sm text-gray-600 mt-1">Review applications → publish polls → manage visibility.</p>

    <!-- Pending applications -->
    <section class="vh-card border border-gray-100 shadow rounded p-6 mb-8 mt-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Pending Applications</h2>
        <span class="text-sm text-gray-500" id="pendingHint"></span>
      </div>
      <div id="pendingList" class="divide-y"></div>
    </section>

    <!-- Existing polls quick view -->
    <section class="vh-card border border-gray-100 shadow rounded p-6">
      <div class="flex items-center justify-between mb-3 gap-3 flex-wrap">
        <h2 class="text-xl font-semibold">Published Polls</h2>
        <div class="flex items-center gap-2">
          <input id="search" type="text" placeholder="Search title…" class="vh-input border rounded px-3 py-2 w-72">
          <a href="moderation.html" class="vh-link text-sm">Go to Moderation →</a>
        </div>
      </div>
      <div id="pollList" class="divide-y"></div>
    </section>
  </main>

  <footer class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white py-6 mt-16">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
      <span>© 2025 VoteHive</span>
      <div class="flex gap-6">
        <a href="#" class="hover:underline">About</a>
        <a href="#" class="hover:underline">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    // ----- Storage helpers (shared keys) -----
    const getPolls   = () => { try { return JSON.parse(localStorage.getItem('customPolls') || '{}'); } catch { return {}; } };
    const setPolls   = (d) => localStorage.setItem('customPolls', JSON.stringify(d));
    const getLog     = () => { try { return JSON.parse(localStorage.getItem('applicationLog') || '[]'); } catch { return []; } };
    const setLog     = (d) => localStorage.setItem('applicationLog', JSON.stringify(d));

    // Legacy/optional pending store (if you later use it)
    const getPendingObj = () => { try { return JSON.parse(localStorage.getItem('pendingPolls') || '{}'); } catch { return {}; } };
    const setPendingObj = (d) => localStorage.setItem('pendingPolls', JSON.stringify(d));

    const getPoints  = () => { try { return JSON.parse(localStorage.getItem('userPoints') || '{}'); } catch { return {}; } };
    const setPoints  = (d) => localStorage.setItem('userPoints', JSON.stringify(d));
    const getEarned  = () => { try { return JSON.parse(localStorage.getItem('vh_pointsEarned') || '{}'); } catch { return {}; } };
    const setEarned  = (d) => localStorage.setItem('vh_pointsEarned', JSON.stringify(d));

    function awardOnce(key, username, amount){
      const earned = getEarned();
      if (earned[key]) return false;
      const pts = getPoints();
      pts[username] = (pts[username]||0) + amount;
      setPoints(pts);
      earned[key] = true;
      setEarned(earned);
      return true;
    }

    // ----- Pending applications (merge sources) -----
    function getPendingMerged(){
      const out = [];
      // Source A: applicationLog entries with status "pending"
      const log = getLog();
      log.filter(x => x && x.status === 'pending').forEach(x => {
        out.push({
          pid: x.id || ('app-' + Math.random().toString(36).slice(2)),
          title: x.title,
          category: x.category,
          options: x.options || [],
          requestedDays: x.requestedDays || 7,
          submittedAt: x.createdAt || x.submittedAt || new Date().toISOString(),
          applicant: x.applicant || x.user || 'guest',
          context: x.reason || x.context || ''
        });
      });

      // Source B: pendingPolls object (if present)
      const pendObj = getPendingObj();
      Object.entries(pendObj).forEach(([pid, p])=>{
        out.push({
          pid,
          title: p.title,
          category: p.category,
          options: p.options || [],
          requestedDays: p.requestedDays || 7,
          submittedAt: p.submittedAt || p.createdAt || new Date().toISOString(),
          applicant: p.applicant || 'guest',
          context: p.context || ''
        });
      });

      // Deduplicate by (title+applicant+submittedAt) heuristic
      const seen = new Set();
      const unique = [];
      out.forEach(item=>{
        const key = (item.title||'')+'|'+(item.applicant||'')+'|'+(item.submittedAt||'');
        if (!seen.has(key)) { seen.add(key); unique.push(item); }
      });

      // Sort newest first
      unique.sort((a,b)=> new Date(b.submittedAt) - new Date(a.submittedAt));
      return unique;
    }

    function renderPending(){
      const el = document.getElementById('pendingList');
      const items = getPendingMerged();
      document.getElementById('pendingHint').textContent = items.length ? '' : 'No applications pending.';
      el.innerHTML = '';

      items.forEach(p=>{
        const card = document.createElement('div');
        card.className = 'py-4';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <div class="text-sm text-gray-500">Applicant: <strong>${p.applicant || 'guest'}</strong> • Submitted: ${new Date(p.submittedAt).toLocaleString()}</div>
              <div class="font-semibold mt-1">${p.title}</div>
              <div class="text-sm text-gray-600 mt-1">Category: ${p.category || 'General'} • Requested: ${p.requestedDays || 7} days</div>
              <div class="text-sm text-gray-600 mt-1">Options: ${(p.options||[]).join(', ')}</div>
              ${p.context ? `<div class="text-sm text-gray-500 mt-2">${p.context}</div>` : ''}
            </div>
            <div class="w-64 shrink-0 space-y-2">
              <label class="block text-sm font-medium">Approve with duration</label>
              <select data-key="${encodeURIComponent(p.pid)}" class="dur vh-input border rounded px-2 py-1 w-full">
                <option value="1">1 day</option>
                <option value="3">3 days</option>
                <option value="7" selected>7 days</option>
                <option value="30">30 days</option>
              </select>
              <div class="flex gap-2">
                <button data-key="${encodeURIComponent(p.pid)}" class="approve vh-cta px-3 py-1 rounded text-sm">Approve</button>
                <button data-key="${encodeURIComponent(p.pid)}" class="reject vh-btn px-3 py-1 rounded text-sm">Reject</button>
              </div>
            </div>
          </div>
        `;
        el.appendChild(card);
      });

      // Bind actions
      el.querySelectorAll('.approve').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const key = decodeURIComponent(btn.getAttribute('data-key'));
          const sel = el.querySelector(`.dur[data-key="${btn.getAttribute('data-key')}"]`);
          const days = parseInt(sel?.value || '7', 10);
          approveApp(key, days);
        });
      });
      el.querySelectorAll('.reject').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const key = decodeURIComponent(btn.getAttribute('data-key'));
          if (!confirm('Reject this application?')) return;
          rejectApp(key);
        });
      });
    }

    function findAndRemovePendingByKey(key){
      // Remove from pendingPolls if present
      const pend = getPendingObj();
      if (pend[key]) { delete pend[key]; setPendingObj(pend); }

      // Mark matching applicationLog entry as not pending if we can match on title+applicant
      const log = getLog();
      const idx = log.findIndex(x => x && (x.id === key || encodeURIComponent(x.id||'') === encodeURIComponent(key)));
      if (idx >= 0) return { log, idx }; // direct match
      return { log, idx: -1 };
    }

    function approveApp(key, days){
      // 1) Locate the app in merged sources (by key) to get details
      const items = getPendingMerged();
      const app = items.find(x => x.pid === key);
      if (!app){ alert('Application not found.'); renderAll(); return; }

      // 2) Create unique poll id from title
      let id = (app.title || 'poll').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      if (!id) id = 'poll-' + Date.now();
      const polls = getPolls();
      if (polls[id]) id = id + '-' + Date.now();

      // 3) Publish poll
      const nowIso = new Date().toISOString();
      const endTime = new Date(Date.now() + (days || 7)*24*60*60*1000).toISOString();
      polls[id] = {
        title: app.title,
        category: app.category,
        options: app.options,
        endTime,
        createdAt: nowIso,
        createdBy: app.applicant || 'guest',
        featured: false,
        hidden: false
      };
      setPolls(polls);

      // 4) Log decision & award points
      const { log, idx } = findAndRemovePendingByKey(key);
      if (idx >= 0) {
        log[idx] = { ...log[idx], status:'approved', decidedAt: nowIso, pollId: id };
      } else {
        // If we can’t match, append a decision entry
        log.push({ id:key, status:'approved', title:app.title, category:app.category, applicant:app.applicant||'guest', decidedAt: nowIso, pollId:id });
      }
      setLog(log);

      const applicant = app.applicant || 'guest';
      awardOnce(`approval:${applicant}:${id}`, applicant, 10);

      alert('Approved and published! ✅ (+10 points to applicant)');
      renderAll();
    }

    function rejectApp(key){
      const items = getPendingMerged();
      const app = items.find(x => x.pid === key);
      const nowIso = new Date().toISOString();

      // Remove from pending store if present
      const pend = getPendingObj();
      if (pend[key]) { delete pend[key]; setPendingObj(pend); }

      // Update or append log
      const log = getLog();
      const idx = log.findIndex(x => x && (x.id === key || encodeURIComponent(x.id||'') === encodeURIComponent(key)));
      if (idx >= 0) {
        log[idx] = { ...log[idx], status:'rejected', decidedAt: nowIso };
      } else {
        log.push({ id:key, status:'rejected', title:app?.title, category:app?.category, applicant:app?.applicant||'guest', decidedAt: nowIso });
      }
      setLog(log);

      renderAll();
    }

    // ----- Published polls list -----
    function renderPolls(){
      const list = document.getElementById('pollList');
      const q = (document.getElementById('search').value || '').toLowerCase();
      const polls = Object.entries(getPolls()).filter(([id,p])=>{
        if (!p) return false;
        return !q || (p.title||'').toLowerCase().includes(q);
      }).sort((a,b)=> new Date(a[1].endTime) - new Date(b[1].endTime));

      list.innerHTML = polls.length ? '' : '<div class="py-4 text-sm text-gray-600">No polls found.</div>';
      polls.forEach(([id,p])=>{
        const end = new Date(p.endTime);
        const closed = Date.now() > end.getTime();
        const row = document.createElement('div');
        row.className = 'py-4';
        row.innerHTML = `
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 rounded-full text-xs ${closed?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}">${closed?'Closed':'Open'}</span>
                <span class="text-xs text-gray-500">${p.category||'General'}</span>
                ${p.featured?'<span class="px-2 py-0.5 rounded-full text-xs bg-yellow-100 text-yellow-700">Featured</span>':''}
                ${p.hidden?'<span class="px-2 py-0.5 rounded-full text-xs bg-gray-200 text-gray-700">Hidden</span>':''}
              </div>
              <div class="font-semibold mt-1">${p.title}</div>
              <div class="text-xs text-gray-500">Ends: ${isNaN(end)?'N/A':end.toLocaleString()}</div>
              <div class="text-xs text-gray-500">By: ${p.createdBy||'—'}</div>
            </div>
            <div class="flex flex-col gap-2">
              <a href="poll.html?id=${encodeURIComponent(id)}" target="_blank" class="vh-btn px-3 py-1 rounded text-sm text-center">Open</a>
              <button data-id="${id}" class="feature vh-btn px-3 py-1 rounded text-sm">${p.featured?'Unfeature':'Feature'}</button>
              <button data-id="${id}" class="hide vh-btn px-3 py-1 rounded text-sm">${p.hidden?'Unhide':'Hide'}</button>
              <div class="flex gap-2">
                <button data-id="${id}" class="extend vh-btn px-3 py-1 rounded text-sm">+7d</button>
                <button data-id="${id}" class="closeNow vh-btn px-3 py-1 rounded text-sm">Close Now</button>
              </div>
              <button data-id="${id}" class="delete vh-btn px-3 py-1 rounded text-sm">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(row);
      });

      // actions
      list.querySelectorAll('.feature').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id'); const polls=getPolls(); polls[id].featured=!polls[id].featured; setPolls(polls); renderPolls();
      }));
      list.querySelectorAll('.hide').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id'); const polls=getPolls(); polls[id].hidden=!polls[id].hidden; setPolls(polls); renderPolls();
      }));
      list.querySelectorAll('.closeNow').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id'); const polls=getPolls(); polls[id].endTime=new Date(Date.now()-1000).toISOString(); setPolls(polls); renderPolls();
      }));
      list.querySelectorAll('.extend').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id'); const polls=getPolls(); const cur=new Date(polls[id].endTime||Date.now()); polls[id].endTime=new Date(cur.getTime()+7*24*60*60*1000).toISOString(); setPolls(polls); renderPolls();
      }));
      list.querySelectorAll('.delete').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id'); if(!confirm('Delete this poll?')) return; const polls=getPolls(); delete polls[id]; setPolls(polls); renderPolls();
      }));
    }

    document.getElementById('search').addEventListener('input', renderPolls);

    function renderAll(){ renderPending(); renderPolls(); }
    renderAll();
  </script>
</body>
</html>