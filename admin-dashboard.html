<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard – VoteHive</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <style>
    html.vh-dark body { background-color:#0f172a; color:#e5e7eb; }
    html.vh-dark header, html.vh-dark footer { filter: brightness(0.9); }
    .vh-card { background:#fff; }
    html.vh-dark .vh-card { background:#111827; border-color:#1f2937; }
    .vh-btn-light { background:#fff; color:#6b21a8; }
    html.vh-dark .vh-btn-light { background:#1f2937; color:#d8b4fe; }
  </style>
  <script src="theme.js"></script>
</head>
<body class="bg-gray-100">
  <!-- Header -->
  <header class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white">
    <div class="max-w-7xl mx-auto px-4 py-6 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <img src="/logo.svg" alt="VoteHive Logo" class="w-8 h-8">
        <span class="text-xl font-bold">VoteHive Admin</span>
      </div>
      <nav class="flex gap-3 text-sm items-center">
        <a href="index.html" class="hover:underline">Home</a>
        <a href="browse.html" class="hover:underline">Browse</a>
        <a href="applications.html" class="hover:underline">Applications</a>
        <button id="themeToggle" onclick="toggleTheme()" class="vh-btn-light px-3 py-1 rounded hover:bg-gray-200">Toggle Theme</button>
        <button id="logoutBtn" class="vh-btn-light px-3 py-1 rounded hover:bg-gray-200">Log Out</button>
      </nav>
    </div>
  </header>

  <!-- Guard -->
  <script>
    if (localStorage.getItem('role') !== 'superadmin') location.href = 'login.html';
  </script>

  <!-- Content -->
  <main class="max-w-7xl mx-auto px-4 py-10">
    <h1 class="text-3xl font-bold mb-6">Superadmin Dashboard</h1>

    <!-- Stats -->
    <section class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
      <div class="vh-card border border-gray-100 shadow rounded p-6">
        <div class="text-sm text-gray-500">Total Users</div>
        <div id="statUsers" class="text-3xl font-extrabold text-green-700 mt-1">0</div>
      </div>
      <div class="vh-card border border-gray-100 shadow rounded p-6">
        <div class="text-sm text-gray-500">Total Polls</div>
        <div id="statPolls" class="text-3xl font-extrabold text-indigo-700 mt-1">0</div>
      </div>
      <div class="vh-card border border-gray-100 shadow rounded p-6">
        <div class="text-sm text-gray-500">Open Polls</div>
        <div id="statOpen" class="text-3xl font-extrabold text-yellow-700 mt-1">0</div>
      </div>
      <div class="vh-card border border-gray-100 shadow rounded p-6">
        <div class="text-sm text-gray-500">Pending Applications</div>
        <div id="statPending" class="text-3xl font-extrabold text-purple-700 mt-1">0</div>
      </div>
      <div class="vh-card border border-gray-100 shadow rounded p-6">
        <div class="text-sm text-gray-500">Flags</div>
        <div id="statFlags" class="text-3xl font-extrabold text-red-700 mt-1">0</div>
      </div>
    </section>

    <!-- Pending applications -->
    <section class="vh-card border border-gray-100 shadow rounded p-6 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Pending Applications</h2>
        <span class="text-sm text-gray-500" id="pendingHint"></span>
      </div>
      <div id="pendingList" class="divide-y"></div>
    </section>

    <!-- Users -->
    <section class="vh-card border border-gray-100 shadow rounded p-6 mb-8">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Users</h2>
        <span id="usersHint" class="text-sm text-gray-500"></span>
      </div>
      <div id="usersTable" class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-600 border-b">
              <th class="py-2 pr-4">Username</th>
              <th class="py-2 pr-4">Role</th>
              <th class="py-2 pr-4">Created</th>
              <th class="py-2 pr-4">Last Login</th>
              <th class="py-2 pr-4">Actions</th>
            </tr>
          </thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Existing polls -->
    <section class="vh-card border border-gray-100 shadow rounded p-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">All Polls</h2>
        <div class="flex items-center gap-2">
          <input id="search" type="text" placeholder="Search title…" class="border rounded px-3 py-2 w-64">
          <select id="filterState" class="border rounded px-3 py-2">
            <option value="">All states</option>
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>
        </div>
      </div>
      <div id="pollList" class="divide-y"></div>
    </section>
  </main>

  <script>
    // Helpers
    const getUsers = () => { try { return JSON.parse(localStorage.getItem('userList') || '[]'); } catch { return []; } };
    const setUsers = (d) => localStorage.setItem('userList', JSON.stringify(d));
    const getPolls = () => { try { return JSON.parse(localStorage.getItem('customPolls') || '{}'); } catch { return {}; } };
    const setPolls = (d) => localStorage.setItem('customPolls', JSON.stringify(d));
    const getPending = () => { try { return JSON.parse(localStorage.getItem('pendingPolls') || '{}'); } catch { return {}; } };
    const setPending = (d) => localStorage.setItem('pendingPolls', JSON.stringify(d));
    const getLog = () => { try { return JSON.parse(localStorage.getItem('applicationLog') || '[]'); } catch { return []; } };
    const setLog = (d) => localStorage.setItem('applicationLog', JSON.stringify(d));
    const getFlags = () => { try { return JSON.parse(localStorage.getItem('pollFlags') || '{}'); } catch { return {}; } };
    const setFlags = (d) => localStorage.setItem('pollFlags', JSON.stringify(d));

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('role'); localStorage.removeItem('username'); location.href = 'index.html';
    });

    function render() {
      const users = getUsers();
      const polls = getPolls();
      const pending = getPending();
      const flags  = getFlags();

      document.getElementById('statUsers').textContent = users.length;
      document.getElementById('statPolls').textContent = Object.keys(polls).length;
      document.getElementById('statPending').textContent = Object.keys(pending).length;
      document.getElementById('statOpen').textContent =
        Object.values(polls).filter(p => !p.hidden && new Date(p.endTime) > new Date()).length;
      document.getElementById('statFlags').textContent =
        Object.values(flags).reduce((a,b)=>a+(b||0),0);

      renderPending(pending);
      renderUsers(users);
      renderPolls(polls, flags);
    }

    // Pending
    function renderPending(pending) {
      const el = document.getElementById('pendingList');
      const items = Object.entries(pending).sort((a,b)=> new Date(b[1].submittedAt) - new Date(a[1].submittedAt));
      document.getElementById('pendingHint').textContent = items.length ? '' : 'No applications pending.';
      el.innerHTML = '';
      items.forEach(([pid, p]) => {
        const row = document.createElement('div');
        row.className = 'py-4 flex gap-4 justify-between items-start';
        row.innerHTML = `
          <div class="flex-1">
            <div class="text-sm text-gray-500">Applicant: <strong>${p.applicant || 'guest'}</strong> • Submitted: ${new Date(p.submittedAt).toLocaleString()}</div>
            <div class="font-semibold mt-1">${p.title}</div>
            <div class="text-sm text-gray-600 mt-1">Category: ${p.category || 'General'}</div>
            <div class="text-sm text-gray-600 mt-1">Options: ${(p.options||[]).join(', ')}</div>
            ${p.context ? `<div class="text-sm text-gray-500 mt-2">${p.context}</div>` : ''}
          </div>
          <div class="w-64 shrink-0 space-y-2">
            <label class="block text-sm font-medium">Duration</label>
            <select data-pid="${pid}" class="dur border rounded px-2 py-1 w-full">
              <option value="1">1 day</option>
              <option value="3">3 days</option>
              <option value="7" selected>7 days</option>
              <option value="30">30 days</option>
            </select>
            <div class="flex gap-2">
              <button data-pid="${pid}" class="approve bg-indigo-600 text-white px-3 py-1 rounded text-sm">Approve</button>
              <button data-pid="${pid}" class="reject bg-gray-100 text-gray-800 px-3 py-1 rounded text-sm">Reject</button>
            </div>
          </div>
        `;
        el.appendChild(row);
      });

      // Bind decisions
      el.querySelectorAll('.approve').forEach(btn => {
        btn.addEventListener('click', () => {
          const pid = btn.getAttribute('data-pid');
          const durSel = el.querySelector(`.dur[data-pid="${pid}"]`);
          const days = parseInt(durSel?.value || '7', 10);
          approveApplication(pid, days);
        });
      });
      el.querySelectorAll('.reject').forEach(btn => {
        btn.addEventListener('click', () => {
          const pid = btn.getAttribute('data-pid');
          if (!confirm('Reject this application?')) return;
          const pend = getPending();
          const app = pend[pid]; if (!app) return;
          const log = getLog();
          log.push({
            id: pid, status: 'rejected', title: app.title, category: app.category,
            applicant: app.applicant || 'guest', decidedAt: new Date().toISOString()
          });
          setLog(log);
          delete pend[pid]; setPending(pend); render();
        });
      });
    }

    function approveApplication(pid, days) {
      const pend = getPending();
      const app = pend[pid]; if (!app) return;

      let id = (app.title || 'poll').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      if (!id) id = 'poll-' + Date.now();
      const polls = getPolls();
      if (polls[id]) id = id + '-' + Date.now();

      const endTime = new Date(Date.now() + days*24*60*60*1000).toISOString();
      polls[id] = { title: app.title, category: app.category, options: app.options, endTime, createdBy: app.applicant || 'guest', featured: false, hidden: false };
      setPolls(polls);

      const log = getLog();
      log.push({
        id: pid, status: 'approved', title: app.title, category: app.category,
        applicant: app.applicant || 'guest', decidedAt: new Date().toISOString(), pollId: id
      });
      setLog(log);

      delete pend[pid]; setPending(pend);
      render(); alert('Approved and published!');
    }

    // Users
    function renderUsers(users){
      const body = document.getElementById('usersBody');
      document.getElementById('usersHint').textContent = users.length ? '' : 'No users yet.';
      body.innerHTML = '';
      users
        .sort((a,b)=> new Date(b.lastLoginAt) - new Date(a.lastLoginAt))
        .forEach(u=>{
          const tr = document.createElement('tr');
          tr.className = 'border-b';
          tr.innerHTML = `
            <td class="py-2 pr-4">${u.username}</td>
            <td class="py-2 pr-4">${u.role || 'user'}</td>
            <td class="py-2 pr-4">${u.createdAt ? new Date(u.createdAt).toLocaleString() : '—'}</td>
            <td class="py-2 pr-4">${u.lastLoginAt ? new Date(u.lastLoginAt).toLocaleString() : '—'}</td>
            <td class="py-2 pr-4">
              <button class="removeUser bg-gray-100 text-gray-800 px-3 py-1 rounded text-sm" data-username="${u.username}">Remove</button>
            </td>
          `;
          body.appendChild(tr);
        });

      body.querySelectorAll('.removeUser').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const uname = btn.getAttribute('data-username');
          if (!confirm(`Remove user "${uname}"?`)) return;
          let users = getUsers();
          users = users.filter(u => u.username !== uname);
          setUsers(users);
          render();
        });
      });
    }

    // Polls table (with flags + hide)
    function renderPolls(polls, flags){
      const list = document.getElementById('pollList');
      const term = (document.getElementById('search').value || '').toLowerCase();
      const state = document.getElementById('filterState').value;

      const entries = Object.entries(polls).filter(([id,p])=>{
        const titleOk = !term || (p.title||'').toLowerCase().includes(term);
        const end = new Date(p.endTime);
        const closed = Date.now() > end.getTime();
        const stOk = !state || (state==='open' && !closed) || (state==='closed' && closed);
        return titleOk && stOk;
      }).sort((a,b)=> new Date(a[1].endTime)-new Date(b[1].endTime));

      list.innerHTML = entries.length ? '' : '<div class="py-4 text-sm text-gray-600">No polls found.</div>';
      entries.forEach(([id,p])=>{
        const end = new Date(p.endTime);
        const closed = Date.now() > end.getTime();
        const fcount = flags[id] || 0;
        const row = document.createElement('div');
        row.className = 'py-4 flex items-start justify-between gap-4';
        row.innerHTML = `
          <div>
            <div class="flex items-center gap-2">
              <span class="px-2 py-0.5 rounded-full text-xs ${closed?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}">${closed?'Closed':'Open'}</span>
              <span class="text-xs text-gray-500">${p.category||'General'}</span>
              ${p.featured?'<span class="px-2 py-0.5 rounded-full text-xs bg-yellow-100 text-yellow-700">Featured</span>':''}
              ${p.hidden?'<span class="px-2 py-0.5 rounded-full text-xs bg-gray-200 text-gray-700">Hidden</span>':''}
              ${fcount?`<span class="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-700">Flags: ${fcount}</span>`:''}
            </div>
            <div class="font-semibold mt-1">${p.title}</div>
            <div class="text-xs text-gray-500">Ends: ${isNaN(end)?'N/A':end.toLocaleString()}</div>
            <div class="text-xs text-gray-500">By: ${p.createdBy||'—'}</div>
          </div>
          <div class="flex flex-col gap-2">
            <a href="poll.html?id=${encodeURIComponent(id)}" target="_blank" class="bg-gray-100 text-gray-800 px-3 py-1 rounded text-sm text-center">Open</a>
            <button data-id="${id}" class="feature bg-gray-100 text-gray-800 px-3 py-1 rounded text-sm">${p.featured?'Unfeature':'Feature'}</button>
            <button data-id="${id}" class="hide bg-gray-100 text-gray-800 px-3 py-1 rounded text-sm">${p.hidden?'Unhide':'Hide'}</button>
            <button data-id="${id}" class="closeNow bg-gray-100 text-gray-800 px-3 py-1 rounded text-sm">Close Now</button>
            <button data-id="${id}" class="delete bg-gray-100 text-gray-800 px-3 py-1 rounded text-sm">Delete</button>
          </div>
        `;
        list.appendChild(row);
      });

      // actions
      list.querySelectorAll('.feature').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id'); const polls=getPolls(); polls[id].featured=!polls[id].featured; setPolls(polls); render();
      }));
      list.querySelectorAll('.hide').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id'); const polls=getPolls(); polls[id].hidden=!polls[id].hidden; setPolls(polls); render();
      }));
      list.querySelectorAll('.closeNow').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id'); const polls=getPolls(); polls[id].endTime=new Date(Date.now()-1000).toISOString(); setPolls(polls); render();
      }));
      list.querySelectorAll('.delete').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id'); if(!confirm('Delete this poll?')) return; const polls=getPolls(); delete polls[id]; setPolls(polls); render();
      }));
    }

    document.getElementById('search').addEventListener('input', render);
    document.getElementById('filterState').addEventListener('change', render);

    render();
  </script>
</body>
</html>