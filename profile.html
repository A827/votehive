<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile â€“ VoteHive</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <style>
    html.vh-dark body { background-color:#0f172a; color:#e5e7eb; }
    .vh-card { background:#fff; }
    html.vh-dark .vh-card { background:#111827; border-color:#1f2937; }
    .badge { font-size:12px; border-radius:9999px; padding:2px 8px; display:inline-block }
    .stat { border-radius:12px; padding:14px; }
    html.vh-dark .stat { background:#0b1222; border:1px solid #1f2937; }
  </style>
  <script src="theme.js"></script>
  <script src="auth.js" defer></script>
</head>
<body class="bg-white text-gray-800 font-sans">
  <!-- Header -->
  <header class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white">
    <div class="max-w-7xl mx-auto px-4 py-6 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <img src="/logo.svg" alt="VoteHive Logo" class="w-8 h-8">
        <span class="text-xl font-bold">VoteHive</span>
      </div>
      <nav class="flex gap-3 text-sm items-center">
        <a href="index.html" class="hover:underline">Home</a>
        <a href="browse.html" class="hover:underline">Browse</a>
        <a href="rewards.html" class="hover:underline">Rewards</a>
        <a href="create.html" class="bg-white text-purple-700 px-3 py-1 rounded hover:bg-gray-200">Apply to Create</a>
        <button onclick="toggleTheme()" class="bg-white text-purple-700 px-3 py-1 rounded hover:bg-gray-200">Toggle Theme</button>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-12">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left: profile summary -->
      <section class="vh-card border border-gray-100 shadow rounded p-6">
        <div class="flex items-center gap-3">
          <div id="avatar" class="w-12 h-12 rounded-full bg-purple-600 text-white grid place-items-center font-bold text-lg">U</div>
          <div>
            <h1 id="username" class="text-2xl font-bold">guest</h1>
            <p id="role" class="text-sm text-gray-600">user</p>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mt-6">
          <div class="stat">
            <div class="text-xs text-gray-500">Points</div>
            <div id="points" class="text-2xl font-extrabold mt-1">0</div>
          </div>
          <div class="stat">
            <div class="text-xs text-gray-500">Badge</div>
            <div id="badge" class="mt-1 badge bg-gray-200 text-gray-800">None</div>
          </div>
          <div class="stat">
            <div class="text-xs text-gray-500">Votes</div>
            <div id="votesCount" class="text-2xl font-extrabold mt-1">0</div>
          </div>
        </div>

        <div class="mt-6">
          <label class="block text-sm font-medium mb-1">Bio (local only)</label>
          <textarea id="bio" rows="3" class="w-full border rounded px-3 py-2" placeholder="Tell people what youâ€™re intoâ€¦"></textarea>
          <button id="saveBio" class="mt-2 bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-1 rounded text-sm">Save</button>
          <p id="bioSaved" class="text-green-600 text-sm mt-1 hidden">Saved.</p>
        </div>
      </section>

      <!-- Right: history -->
      <section class="vh-card border border-gray-100 shadow rounded p-6 lg:col-span-2">
        <h2 class="text-xl font-semibold mb-4">Activity</h2>

        <div class="mb-6">
          <h3 class="font-semibold mb-2">Your Votes</h3>
          <div id="votesList" class="space-y-3"></div>
        </div>

        <div class="mb-6">
          <h3 class="font-semibold mb-2">Your Polls (approved)</h3>
          <div id="pollsList" class="space-y-3"></div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Applications</h3>
          <div id="appsList" class="space-y-3"></div>
        </div>
      </section>
    </div>
  </main>

  <footer class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white py-6 mt-16">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
      <span>Â© 2025 VoteHive</span>
      <div class="flex gap-6">
        <a href="#" class="hover:underline">About</a>
        <a href="#" class="hover:underline">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    // storage
    const session = (window.VHAuth?.current?.() || {username:'guest', role:'user'});
    const me = session.username;
    const role = session.role || 'user';

    const getPoints = () => { try { return JSON.parse(localStorage.getItem('userPoints')||'{}'); } catch { return {}; } };
    const getVotesByUser = () => { try { return JSON.parse(localStorage.getItem('vh_votesByUser')||'{}'); } catch { return {}; } };
    const getPolls = () => { try { return JSON.parse(localStorage.getItem('customPolls')||'{}'); } catch { return {}; } };
    const getLog = () => { try { return JSON.parse(localStorage.getItem('applicationLog')||'[]'); } catch { return []; } };

    const bioKey = (u)=> `vh_bio:${u}`;

    // badge
    function badgeFor(points){
      if (points >= 400) return {name:'Diamond', cls:'bg-indigo-100 text-indigo-800', icon:'ðŸ”·'};
      if (points >= 150) return {name:'Gold', cls:'bg-yellow-100 text-yellow-800', icon:'ðŸŸ¡'};
      if (points >= 50)  return {name:'Silver', cls:'bg-gray-100 text-gray-800', icon:'âšªï¸'};
      if (points >= 10)  return {name:'Bronze', cls:'bg-amber-100 text-amber-800', icon:'ðŸŸ¤'};
      return {name:'None', cls:'bg-gray-200 text-gray-800', icon:'â€”'};
    }

    // populate header card
    (function initProfile(){
      document.getElementById('username').textContent = me;
      document.getElementById('role').textContent = role;
      document.getElementById('avatar').textContent = (me||'?').slice(0,1).toUpperCase();

      const pts = getPoints()[me] || 0;
      document.getElementById('points').textContent = pts;
      const b = badgeFor(pts);
      const bd = document.getElementById('badge');
      bd.textContent = `${b.icon} ${b.name}`;
      bd.className = `badge ${b.cls}`;

      const votes = Object.keys(getVotesByUser()[me] || {}).length;
      document.getElementById('votesCount').textContent = votes;

      // bio load/save
      const savedBio = localStorage.getItem(bioKey(me)) || '';
      const bio = document.getElementById('bio');
      const note = document.getElementById('bioSaved');
      bio.value = savedBio;
      document.getElementById('saveBio').addEventListener('click', ()=>{
        localStorage.setItem(bioKey(me), bio.value.trim().slice(0, 600));
        note.classList.remove('hidden');
        setTimeout(()=>note.classList.add('hidden'), 1200);
      });
    })();

    // activity: votes
    (function renderVotes(){
      const holder = document.getElementById('votesList');
      const voted = getVotesByUser()[me] || {};
      const polls = getPolls();
      const ids = Object.keys(voted);
      if (!ids.length) { holder.innerHTML = '<div class="text-sm text-gray-500">No votes yet.</div>'; return; }
      holder.innerHTML = '';
      ids.forEach(id=>{
        const p = polls[id];
        const link = p ? `<a class="text-indigo-600 hover:underline" href="poll.html?id=${encodeURIComponent(id)}">${p.title}</a>` : `<span class="text-gray-600">(deleted poll)</span>`;
        holder.insertAdjacentHTML('beforeend', `
          <div class="border rounded p-3 text-sm flex items-center justify-between">
            <div>${link}<div class="text-xs text-gray-500">${p?.category||'General'}</div></div>
            <div class="text-xs text-gray-600">Your vote: <strong>${voted[id]}</strong></div>
          </div>
        `);
      });
    })();

    // activity: approved polls by me
    (function renderApproved(){
      const holder = document.getElementById('pollsList');
      const polls = getPolls();
      const my = Object.entries(polls).filter(([id,p]) => p?.createdBy === me);
      if (!my.length) { holder.innerHTML = '<div class="text-sm text-gray-500">No approved polls yet.</div>'; return; }
      holder.innerHTML = '';
      my.forEach(([id,p])=>{
        const end = new Date(p.endTime);
        const closed = Date.now() > end.getTime();
        holder.insertAdjacentHTML('beforeend', `
          <div class="border rounded p-3 text-sm flex items-center justify-between">
            <div>
              <a class="text-indigo-600 hover:underline" href="poll.html?id=${encodeURIComponent(id)}">${p.title}</a>
              <div class="text-xs text-gray-500">${p.category||'General'} â€¢ Ends: ${isNaN(end)?'N/A':end.toLocaleString()}</div>
            </div>
            <span class="px-2 py-0.5 rounded-full text-xs ${closed?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}">${closed?'Closed':'Open'}</span>
          </div>
        `);
      });
    })();

    // activity: applications history
    (function renderApps(){
      const holder = document.getElementById('appsList');
      const log = getLog().filter(x => (x.applicant||'guest') === me).reverse();
      if (!log.length) { holder.innerHTML = '<div class="text-sm text-gray-500">No application history.</div>'; return; }
      holder.innerHTML = '';
      log.forEach(x=>{
        const link = x.pollId ? `<a class="text-indigo-600 hover:underline" href="poll.html?id=${encodeURIComponent(x.pollId)}">Open poll</a>` : '';
        holder.insertAdjacentHTML('beforeend', `
          <div class="border rounded p-3 text-sm flex items-center justify-between">
            <div>
              <div class="font-medium">${x.title}</div>
              <div class="text-xs text-gray-500">${x.category||'General'} â€¢ ${new Date(x.decidedAt).toLocaleString()}</div>
            </div>
            <div class="flex items-center gap-2">
              ${link}
              <span class="px-2 py-0.5 rounded-full text-xs ${x.status==='approved'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${x.status}</span>
            </div>
          </div>
        `);
      });
    })();
  </script>
</body>
</html>