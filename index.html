<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VoteHive ‚Äì Where Ideas Compete</title>
  <meta name="description" content="VoteHive: create and vote on trending ideas across categories. See live activity, trending polls, and top voters." />
  <link rel="icon" href="/favicon.ico"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <style>
    .chip{display:inline-block;padding:2px 10px;border-radius:9999px;font-size:12px;line-height:20px}
    .scrollhide::-webkit-scrollbar{display:none}
    .ticker{white-space:nowrap;overflow:hidden}
    .ticker > div{display:inline-block;padding-left:100%;animation:marquee 18s linear infinite}
    @keyframes marquee {0%{transform:translate(0,0)}100%{transform:translate(-100%,0)}}
    @media (prefers-reduced-motion: reduce){ .ticker > div{animation:none; padding-left:0} }
    .countdown{font-variant-numeric:tabular-nums}
    .img-thumb{object-fit:cover}
    .clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  </style>
</head>
<body class="bg-white text-gray-800 font-sans">

  <!-- Role-aware header -->
  <div id="vh-header"></div>
  <!-- IMPORTANT: keep this order, using defer to avoid blocking -->
  <script src="auth.js" defer></script>
  <script src="guard.js" defer></script>
  <script src="header.js" defer></script>

  <!-- HERO with Spotlight + Ticker -->
  <section class="relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-indigo-700 to-purple-700" aria-hidden="true"></div>
    <div class="relative max-w-7xl mx-auto px-4 py-14 md:py-18 text-white">
      <div class="grid md:grid-cols-3 gap-6 items-stretch">
        <!-- Left: Claim + CTAs -->
        <div class="md:col-span-1 flex flex-col justify-between">
          <div>
            <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">
              Where <span class="text-yellow-300">Ideas</span> Compete
            </h1>
            <p class="mt-4 text-white/90 md:text-lg">
              Vote in real time, join the discussion, and uncover what people really think.
            </p>
          </div>
          <div class="mt-6 flex flex-wrap gap-3">
            <a href="create.html" class="bg-white text-indigo-700 px-5 py-3 rounded font-semibold text-sm hover:bg-gray-100">Apply to Create</a>
            <a href="browse.html" class="border border-white/80 px-5 py-3 rounded font-semibold text-sm hover:bg-white hover:text-purple-700">Browse Polls</a>
            <a href="leaderboard.html" class="border border-white/80 px-5 py-3 rounded font-semibold text-sm hover:bg-white hover:text-purple-700">Leaderboard</a>
          </div>
        </div>

        <!-- Middle: Spotlight -->
        <div class="md:col-span-1">
          <div class="rounded-2xl shadow-2xl bg-white/10 border border-white/10 p-4 h-full">
            <div class="text-sm text-white/90 mb-2">Daily Spotlight</div>
            <article id="spotlight" class="bg-white/10 rounded-xl overflow-hidden" aria-live="polite">
              <!-- Filled by JS -->
            </article>
          </div>
        </div>

        <!-- Right: Activity Ticker -->
        <div class="md:col-span-1">
          <div class="rounded-2xl shadow-2xl bg-white/10 border border-white/10 p-4 h-full">
            <div class="text-sm text-white/90 mb-2">Live Activity</div>
            <div class="ticker bg-white/10 rounded-lg" aria-live="polite">
              <div id="tickerInner" class="py-3 text-sm">
                <!-- Items injected by JS -->
              </div>
            </div>
            <div class="mt-3 text-xs text-white/70">Real-time feed of votes, comments and shares.</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Search + Categories -->
  <section class="max-w-7xl mx-auto px-4 pt-8 pb-4">
    <div class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2">
        <div class="flex gap-2">
          <input id="search" class="w-full border rounded px-3 py-3" placeholder="Search polls by title‚Ä¶" aria-label="Search polls by title"/>
          <a id="searchBtn" href="browse.html" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded text-sm">Search</a>
        </div>
      </div>
      <div class="md:col-span-1">
        <div class="flex gap-2 overflow-x-auto scrollhide" aria-label="Popular categories">
          <a href="browse.html?category=Startups" class="chip bg-indigo-50 text-indigo-700">Startups</a>
          <a href="browse.html?category=Brands" class="chip bg-indigo-50 text-indigo-700">Brands</a>
          <a href="browse.html?category=Politics" class="chip bg-indigo-50 text-indigo-700">Politics</a>
          <a href="browse.html?category=Finance" class="chip bg-indigo-50 text-indigo-700">Finance</a>
          <a href="browse.html?category=Design" class="chip bg-indigo-50 text-indigo-700">Design</a>
          <a href="browse.html?category=Parenting" class="chip bg-indigo-50 text-indigo-700">Parenting</a>
          <a href="browse.html?category=Real%20Estate" class="chip bg-indigo-50 text-indigo-700">Real Estate</a>
          <a href="browse.html?category=Entertainment" class="chip bg-indigo-50 text-indigo-700">Entertainment</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Trending with Thumbnails -->
  <section class="max-w-7xl mx-auto px-4 pb-4">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl md:text-2xl font-bold">Trending Polls</h2>
      <div class="text-sm text-gray-500" id="trendingMeta" aria-live="polite"></div>
    </div>
    <div id="trendingGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <div id="trendingEmpty" class="hidden text-center text-gray-500 bg-gray-50 p-10 rounded">
      No polls yet. Be the first to <a class="text-indigo-600 underline" href="create.html">apply</a>.
    </div>
  </section>

  <!-- Top Voters (social proof) -->
  <section class="max-w-7xl mx-auto px-4 py-8 bg-gray-50 rounded-2xl">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl md:text-2xl font-bold">Top Voters This Week</h2>
      <a href="leaderboard.html" class="text-sm text-indigo-600 hover:underline">Full leaderboard</a>
    </div>
    <div id="topVoters" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
  </section>

  <!-- CTA band -->
  <section class="mt-8">
    <div class="max-w-7xl mx-auto px-4">
      <div class="rounded-2xl bg-gradient-to-r from-indigo-700 to-purple-700 text-white p-6 md:p-8 flex flex-col md:flex-row md:items-center md:justify-between">
        <div class="mb-4 md:mb-0">
          <h3 class="text-xl font-semibold">Ready to put your idea to the test?</h3>
          <p class="text-white/90 text-sm mt-1">Submit your poll for review. If approved, it goes live to the crowd.</p>
        </div>
        <div class="flex gap-3">
          <a href="create.html" class="bg-white text-purple-700 px-5 py-3 rounded font-semibold text-sm hover:bg-gray-100">Apply to Create</a>
          <a href="leaderboard.html" class="border border-white/80 px-5 py-3 rounded font-semibold text-sm hover:bg-white hover:text-purple-700">View Leaderboard</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-50 mt-12">
    <div class="max-w-7xl mx-auto px-4 py-8 text-sm flex flex-col md:flex-row items-center justify-between">
      <div class="flex items-center gap-2">
        <img src="/logo.svg" alt="VoteHive logo" class="w-6 h-6" loading="lazy" decoding="async">
        <span class="font-semibold">VoteHive</span>
      </div>
      <div class="mt-3 md:mt-0 text-gray-500">¬© 2025 VoteHive ‚Ä¢ <a href="#" class="hover:underline">About</a> ‚Ä¢ <a href="#" class="hover:underline">Contact</a></div>
    </div>
  </footer>

  <!-- Page script -->
  <script>
    // ------- Data helpers -------
    const getPolls = () => { try { return JSON.parse(localStorage.getItem('customPolls')||'{}'); } catch { return {}; } };
    const getVotes = () => { try { return JSON.parse(localStorage.getItem('pollVotes')||'{}'); } catch { return {}; } };
    const getActivity = () => { try { return JSON.parse(localStorage.getItem('activityLog')||'[]'); } catch { return []; } };
    const getPoints = () => { try { return JSON.parse(localStorage.getItem('userPoints')||'{}'); } catch { return {}; } };

    function esc(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
    function totalVotesFor(id){
      const v = getVotes()[id] || {};
      return Object.values(v).reduce((a,b)=> a + (Number(b)||0), 0);
    }

    function trendingScore(id, p){
      if (!p) return -Infinity;
      const end = new Date(p.endTime);
      const hoursLeft = isNaN(end) ? 0 : Math.max(0, (end - new Date()) / 36e5);
      const created = new Date(p.createdAt || Date.now());
      const recency = Math.max(0, 1 - Math.min(1, (Date.now() - created) / (3*864e5))); // ~3 days
      const t = totalVotesFor(id);
      return t * 0.8 + (1/(1+hoursLeft)) * 10 + recency * 5;
    }

    // ------- Spotlight -------
    function spotlightPoll(){
      const polls = getPolls();
      const keys = Object.keys(polls);
      const el = document.getElementById('spotlight');
      let pick = null;

      if (keys.length){
        pick = keys
          .map(id => [id, polls[id]])
          .filter(([_,p]) => p && !p.hidden)
          .sort((a,b)=> trendingScore(b[0],b[1]) - trendingScore(a[0],a[1]))[0];
      }

      if (!pick){
        const demo = {
          id:'demo1',
          title:'Which coffee chain wins in 2025?',
          category:'Brands',
          endTime:new Date(Date.now()+2*864e5).toISOString(),
          thumbnail:'https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?q=80&w=1200&auto=format&fit=crop'
        };
        el.innerHTML = spotlightHTML(demo.id, demo);
        return;
      }
      el.innerHTML = spotlightHTML(pick[0], pick[1]);
    }

    function spotlightHTML(id, p){
      const end = new Date(p.endTime);
      const closed = !isNaN(end) && Date.now() > end.getTime();
      const badge = closed ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
      const votes = totalVotesFor(id);
      const thumb = p.thumbnail || 'https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=1200&auto=format&fit=crop';
      return `
        <div class="grid grid-cols-3 gap-0">
          <div class="col-span-3 h-40 md:h-44 overflow-hidden">
            <img class="w-full h-full img-thumb" src="${thumb}" alt="" loading="lazy" decoding="async">
          </div>
          <div class="col-span-3 p-4">
            <div class="flex items-center gap-2 text-xs mb-1">
              <span class="chip ${badge}">${closed?'Closed':'Open'}</span>
              <span class="text-white/90">${esc(p.category||'General')}</span>
            </div>
            <div class="font-semibold clamp-2">${esc(p.title||'Untitled')}</div>
            <div class="text-xs text-white/80 mt-1">Votes: <strong>${votes}</strong> ‚Ä¢ Ends: ${isNaN(end)?'N/A':end.toLocaleDateString()}</div>
            <a href="poll.html?id=${encodeURIComponent(id)}" class="mt-3 inline-block bg-white text-indigo-700 px-4 py-2 rounded text-sm">Open Poll</a>
          </div>
        </div>
      `;
    }

    // ------- Activity Ticker -------
    function renderTicker(){
      const log = (getActivity()||[]).filter(Boolean).slice(-30).reverse(); // newest first
      const polls = getPolls();
      const fmt = log.map(ev => {
        const p = polls[ev.pid] || {};
        const title = (p.title || 'a poll').slice(0,60);
        if (ev.type === 'vote')   return `<span class="mx-6">üó≥Ô∏è <strong>${esc(ev.user||'Someone')}</strong> voted on <em>${esc(title)}</em></span>`;
        if (ev.type === 'comment')return `<span class="mx-6">üí¨ <strong>${esc(ev.user||'Someone')}</strong> replied in <em>${esc(title)}</em></span>`;
        if (ev.type === 'share')  return `<span class="mx-6">üîó <strong>${esc(ev.user||'Someone')}</strong> shared <em>${esc(title)}</em></span>`;
        return '';
      }).join('') || `<span class="mx-6">Welcome to VoteHive ‚Äî activity will appear here as people vote & comment.</span>`;
      document.getElementById('tickerInner').innerHTML = fmt;
    }

    // ------- Trending Grid with thumbnails -------
    function cardHTML(id, p){
      const end = new Date(p.endTime);
      const closed = !isNaN(end) && Date.now() > end.getTime();
      const badge = closed ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
      const votes = totalVotesFor(id);
      const thumb = p.thumbnail || 'https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=1200&auto=format&fit=crop';
      return `
        <article class="bg-white border border-gray-100 shadow rounded-xl overflow-hidden flex flex-col">
          <div class="h-36 w-full overflow-hidden">
            <img class="w-full h-full img-thumb" src="${thumb}" alt="" loading="lazy" decoding="async">
          </div>
          <div class="p-4 flex-1 flex flex-col">
            <div class="flex items-center gap-2 text-xs mb-1">
              <span class="chip ${badge}">${closed?'Closed':'Open'}</span>
              <span class="text-gray-500">${esc(p.category || 'General')}</span>
              ${p.featured ? '<span class="chip bg-yellow-100 text-yellow-800">Featured</span>' : ''}
            </div>
            <h3 class="font-semibold mb-1 clamp-2">${esc(p.title||'Untitled')}</h3>
            <div class="text-xs text-gray-500">Votes: <strong>${votes}</strong> ‚Ä¢ Ends: ${isNaN(end)?'N/A':end.toLocaleString()}</div>
            <a href="poll.html?id=${encodeURIComponent(id)}" class="mt-3 inline-block bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm self-start">Open</a>
          </div>
        </article>
      `;
    }

    function renderTrending(){
      const polls = getPolls();
      const rows = Object.entries(polls)
        .filter(([_,p]) => p && !p.hidden)
        .sort((a,b) => trendingScore(b[0], b[1]) - trendingScore(a[0], a[1]))
        .slice(0, 6);

      const grid = document.getElementById('trendingGrid');
      const meta = document.getElementById('trendingMeta');

      if (!rows.length){
        const demo = [
          {id:'demo1', title:'Which coffee chain wins in 2025?', category:'Brands', endTime:new Date(Date.now()+2*864e5).toISOString(), thumbnail:'https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?q=80&w=1200&auto=format&fit=crop'},
          {id:'demo2', title:'Should office-first return in tech?', category:'Startups', endTime:new Date(Date.now()+4*864e5).toISOString(), thumbnail:'https://images.unsplash.com/photo-1529336953121-adb1181a7d3b?q=80&w=1200&auto=format&fit=crop'},
          {id:'demo3', title:'Will crypto be mainstream by 2030?', category:'Finance', endTime:new Date(Date.now()+1*864e5).toISOString(), thumbnail:'https://images.unsplash.com/photo-1621768216002-5ac171876625?q=80&w=1200&auto=format&fit=crop'}
        ];
        grid.innerHTML = demo.map(d => cardHTML(d.id, d)).join('');
        meta.textContent = 'Demo data';
        document.getElementById('trendingEmpty').classList.add('hidden');
        return;
      }

      grid.innerHTML = rows.map(([id,p]) => cardHTML(id,p)).join('');
      meta.textContent = `${rows.length} of ${Object.keys(polls).length} shown`;
      document.getElementById('trendingEmpty').classList.toggle('hidden', rows.length>0);
    }

    // ------- Top Voters -------
    function renderTopVoters(){
      const pts = getPoints();
      const rows = Object.entries(pts).sort((a,b)=> (b[1]||0)-(a[1]||0)).slice(0,6);
      const el = document.getElementById('topVoters');
      if (!rows.length){
        el.innerHTML = `
          <div class="text-sm text-gray-500 col-span-full">No voter activity yet. Start by <a class="text-indigo-600 underline" href="browse.html">browsing polls</a>.</div>
        `;
        return;
      }
      el.innerHTML = rows.map(([user,score])=>`
        <div class="bg-white border border-gray-100 rounded-xl p-4 text-center">
          <div class="mx-auto mb-2 w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-700 font-semibold">${esc((user||'U')[0]).toUpperCase()}</div>
          <div class="font-medium">${esc(user)}</div>
          <div class="text-xs text-gray-500">Points: ${score}</div>
        </div>
      `).join('');
    }

    // ------- Search button wiring -------
    (function(){
      const input = document.getElementById('search');
      const btn = document.getElementById('searchBtn');
      btn.addEventListener('click', (e)=>{
        const q = (input.value||'').trim();
        if (!q) return; // keep default href
        btn.href = 'browse.html?q=' + encodeURIComponent(q);
      });
      input.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){ e.preventDefault(); btn.click(); }
      });
    })();

    // Live update sections if other tabs create polls / vote / etc.
    window.addEventListener('storage', (e)=>{
      if (['customPolls','pollVotes','activityLog','userPoints'].includes(e.key)) {
        spotlightPoll();
        renderTrending();
        renderTicker();
        renderTopVoters();
      }
    });

    // ------- Init all -------
    spotlightPoll();
    renderTicker();
    renderTrending();
    renderTopVoters();
  </script>
</body>
</html>