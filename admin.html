<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin Dashboard – VoteHive</title>
  <link rel="icon" href="/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <style>
    .chip{display:inline-block;padding:2px 10px;border-radius:9999px;font-size:12px;line-height:20px}
  </style>
</head>
<body class="bg-white text-gray-800 font-sans">

  <!-- Shared, role-aware header -->
  <div id="vh-header"></div>
  <script src="auth.js"></script>
  <script src="guard.js"></script>
  <script src="header.js"></script>

  <!-- Demo password gate (shown only if not logged in as admin) -->
  <section id="loginGate" class="max-w-md mx-auto px-4 py-16 hidden">
    <h1 class="text-2xl font-bold mb-2">Admin Login</h1>
    <p class="text-gray-600 mb-6">You’re not logged in as an admin. Use the demo password to continue.</p>
    <div class="bg-white border border-gray-100 shadow rounded p-6 space-y-4">
      <div>
        <label class="block font-semibold mb-2">Password</label>
        <input id="adminPass" type="password" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="••••••••">
      </div>
      <div class="flex gap-2">
        <button id="loginBtn" class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-indigo-600 text-white hover:bg-indigo-700">Log In (demo)</button>
        <a href="index.html" class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-gray-100 text-gray-800 hover:bg-gray-200">Cancel</a>
      </div>
      <p id="loginError" class="text-sm text-red-600 hidden mt-2">Incorrect password.</p>
      <p class="text-xs text-gray-500 mt-2">Demo-only gate. We’ll move to Firebase/Auth later.</p>
    </div>
  </section>

  <!-- Admin App -->
  <main id="adminApp" class="max-w-7xl mx-auto px-4 py-10 hidden">
    <div class="flex items-start justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-3xl font-bold mb-2">Admin Dashboard</h1>
        <p class="text-gray-600">Manage polls, feature them, close, or delete. Export/import backups.</p>
        <p id="who" class="text-xs text-gray-500 mt-1"></p>
      </div>
      <div class="flex gap-2">
        <button id="exportBtn" class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-gray-100 text-gray-800 hover:bg-gray-200">Export JSON</button>
        <label class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-gray-100 text-gray-800 hover:bg-gray-200 cursor-pointer">
          Import JSON <input id="importInput" type="file" accept="application/json" class="hidden">
        </label>
        <button id="logoutBtn" class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-gray-100 text-gray-800 hover:bg-gray-200">Log out (admin)</button>
      </div>
    </div>

    <!-- Stats -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">
      <div class="bg-white border border-gray-100 shadow rounded p-5">
        <div class="text-sm text-gray-500">Total Polls</div>
        <div id="statTotal" class="text-3xl font-extrabold mt-1">0</div>
      </div>
      <div class="bg-white border border-gray-100 shadow rounded p-5">
        <div class="text-sm text-gray-500">Open Polls</div>
        <div id="statOpen" class="text-3xl font-extrabold mt-1">0</div>
      </div>
      <div class="bg-white border border-gray-100 shadow rounded p-5">
        <div class="text-sm text-gray-500">Featured</div>
        <div id="statFeatured" class="text-3xl font-extrabold mt-1">0</div>
      </div>
    </section>

    <!-- List + Editor -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
      <!-- Polls list -->
      <div class="lg:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">All Polls</h2>
          <div class="flex items-center gap-2">
            <input id="search" type="text" placeholder="Search title…" class="w-64 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <select id="filterState" class="w-40 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
              <option value="">All states</option>
              <option value="open">Open</option>
              <option value="closed">Closed</option>
            </select>
          </div>
        </div>
        <div id="pollsWrap" class="bg-white border border-gray-100 shadow rounded divide-y"></div>
      </div>

      <!-- Editor -->
      <div class="lg:col-span-1">
        <div class="bg-white border border-gray-100 shadow rounded p-5">
          <h3 class="text-lg font-semibold mb-3">Edit Poll</h3>
          <p id="editHint" class="text-sm text-gray-500 mb-4">Select a poll from the list to edit.</p>
          <form id="editForm" class="space-y-3 hidden">
            <input type="hidden" id="editId">
            <div>
              <label class="block text-sm font-medium mb-1">Title</label>
              <input id="editTitle" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Poll title">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Category</label>
              <input id="editCategory" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Category">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Options (comma-separated)</label>
              <textarea id="editOptions" rows="3" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Option A, Option B, Option C"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">End Time</label>
              <input id="editEnd" type="datetime-local" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
              <p class="text-xs text-gray-500 mt-1">Set a future date to keep it open, or past to close now.</p>
            </div>
            <div class="flex items-center gap-2">
              <input id="editFeatured" type="checkbox" class="h-4 w-4">
              <label for="editFeatured" class="text-sm">Featured</label>
            </div>
            <div class="flex gap-2 pt-2">
              <button class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-indigo-600 text-white hover:bg-indigo-700" id="saveBtn">Save</button>
              <a id="openLink" class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-gray-100 text-gray-800 hover:bg-gray-200" target="_blank" rel="noopener">Open</a>
            </div>
          </form>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white py-6 mt-16">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
      <span>© 2025 VoteHive</span>
      <div class="flex gap-6">
        <a href="#" class="hover:underline">About</a>
        <a href="#" class="hover:underline">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    // ============== CONFIG (demo) ==============
    const ADMIN_PASSWORD = "votehive-dev-2025"; // change if needed

    // ============== AUTH / GATE ==============
    const loginGate = document.getElementById("loginGate");
    const adminApp  = document.getElementById("adminApp");
    const loginBtn  = document.getElementById("loginBtn");
    const adminPass = document.getElementById("adminPass");
    const loginErr  = document.getElementById("loginError");
    const whoEl     = document.getElementById("who");

    function getSession(){ try { return window.VHAuth?.current?.() || JSON.parse(localStorage.getItem('currentUser')||'null'); } catch { return null; } }
    function isRoleAdmin(u){ return !!(u && u.role === 'admin'); }
    function showGate(){ loginGate.classList.remove("hidden"); adminApp.classList.add("hidden"); }
    function showApp(){  loginGate.classList.add("hidden"); adminApp.classList.remove("hidden"); render(); }

    (function gate(){
      const me = getSession();
      if (isRoleAdmin(me)) {
        whoEl.textContent = `Logged in as ${me.username} (admin)`;
        showApp();
      } else if (localStorage.getItem("vh_is_admin") === "1") {
        whoEl.textContent = `Demo admin session (password gate)`;
        showApp();
      } else {
        showGate();
      }
    })();

    loginBtn?.addEventListener("click", ()=>{
      loginErr.classList.add("hidden");
      if (adminPass.value === ADMIN_PASSWORD){
        localStorage.setItem("vh_is_admin", "1");
        adminPass.value = "";
        whoEl.textContent = `Demo admin session (password gate)`;
        showApp();
      } else {
        loginErr.classList.remove("hidden");
      }
    });

    document.getElementById("logoutBtn")?.addEventListener("click", ()=>{
      // end both kinds of sessions
      try { window.VHAuth?.logout?.(); } catch {}
      localStorage.removeItem("vh_is_admin");
      showGate();
      // also update the shared header
      try { localStorage.setItem('__vh_emit__', 'logout:' + Date.now()); } catch {}
      window.VHHeader?.render?.();
    });

    // ============== STORAGE HELPERS ==============
    const getPolls = () => { try { return JSON.parse(localStorage.getItem("customPolls") || "{}"); } catch { return {}; } };
    const setPolls = (p) => localStorage.setItem("customPolls", JSON.stringify(p));

    // ============== DOM REFS ==============
    const exportBtn   = document.getElementById("exportBtn");
    const importInput = document.getElementById("importInput");
    const statTotal   = document.getElementById("statTotal");
    const statOpen    = document.getElementById("statOpen");
    const statFeat    = document.getElementById("statFeatured");
    const pollsWrap   = document.getElementById("pollsWrap");
    const searchEl    = document.getElementById("search");
    const filterState = document.getElementById("filterState");
    const editForm    = document.getElementById("editForm");
    const editHint    = document.getElementById("editHint");
    const editId      = document.getElementById("editId");
    const editTitle   = document.getElementById("editTitle");
    const editCategory= document.getElementById("editCategory");
    const editOptions = document.getElementById("editOptions");
    const editEnd     = document.getElementById("editEnd");
    const editFeatured= document.getElementById("editFeatured");
    const openLink    = document.getElementById("openLink");
    const saveBtn     = document.getElementById("saveBtn");

    // ============== RENDER LIST/STATS ==============
    function render(){
      const polls = getPolls();
      const term  = (searchEl.value || "").toLowerCase();
      const state = filterState.value;

      const entries = Object.entries(polls).filter(([id,p])=>{
        if (!p) return false;
        const titleOk = !term || (p.title||"").toLowerCase().includes(term);
        const end = new Date(p.endTime);
        const closed = !isNaN(end) && Date.now() > end.getTime();
        const stateOk = !state || (state==='open' && !closed) || (state==='closed' && closed);
        return titleOk && stateOk;
      });

      // Stats
      statTotal.textContent = Object.keys(polls).length;
      statOpen.textContent  = Object.values(polls).filter(p => {
        const end = new Date(p.endTime);
        return !isNaN(end) && Date.now() < end.getTime();
      }).length;
      statFeat.textContent  = Object.values(polls).filter(p => p && p.featured).length;

      // List
      pollsWrap.innerHTML = '';
      if (!entries.length){
        pollsWrap.innerHTML = '<div class="p-6 text-gray-600 text-sm">No polls found.</div>';
      } else {
        entries
          .sort((a,b) => new Date(a[1].endTime) - new Date(b[1].endTime))
          .forEach(([id,p])=>{
            const end = new Date(p.endTime);
            const closed = !isNaN(end) && Date.now() > end.getTime();
            const badgeState = closed ? "bg-red-100 text-red-700" : "bg-green-100 text-green-700";
            const feat = p.featured ? "bg-yellow-100 text-yellow-700" : "bg-gray-100 text-gray-600";
            const row = document.createElement('div');
            row.className = 'p-4';
            row.innerHTML = `
              <div class="flex items-start justify-between gap-4">
                <div>
                  <div class="flex items-center gap-2 mb-1">
                    <span class="chip ${badgeState}">${closed?'Closed':'Open'}</span>
                    <span class="chip ${feat}">${p.featured ? 'Featured':'Standard'}</span>
                    <span class="text-gray-500 text-xs">${p.category||'General'}</span>
                  </div>
                  <div class="font-semibold">${p.title || 'Untitled poll'}</div>
                  <div class="text-xs text-gray-500 mt-1">ID: ${id}</div>
                  <div class="text-xs text-gray-500">Ends: ${isNaN(end)?'N/A':end.toLocaleString()}</div>
                </div>
                <div class="flex flex-col gap-2">
                  <a href="poll.html?id=${encodeURIComponent(id)}" target="_blank" class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-gray-100 text-gray-800 hover:bg-gray-200">Open</a>
                  <button data-id="${id}" class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-gray-100 text-gray-800 hover:bg-gray-200 act-edit">Edit</button>
                  <button data-id="${id}" class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-gray-100 text-gray-800 hover:bg-gray-200 act-feature">${p.featured?'Unfeature':'Feature'}</button>
                  <button data-id="${id}" class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-gray-100 text-gray-800 hover:bg-gray-200 act-close">Close Now</button>
                  <button data-id="${id}" class="inline-flex items-center justify-center px-4 py-2 rounded text-sm bg-gray-100 text-gray-800 hover:bg-gray-200 act-delete">Delete</button>
                </div>
              </div>
            `;
            pollsWrap.appendChild(row);
          });

        // Bind actions
        pollsWrap.querySelectorAll('.act-edit').forEach(b => b.addEventListener('click', ()=> loadEditor(b.getAttribute('data-id'))));
        pollsWrap.querySelectorAll('.act-feature').forEach(b => b.addEventListener('click', ()=> toggleFeature(b.getAttribute('data-id'))));
        pollsWrap.querySelectorAll('.act-close').forEach(b => b.addEventListener('click', ()=> closeNow(b.getAttribute('data-id'))));
        pollsWrap.querySelectorAll('.act-delete').forEach(b => b.addEventListener('click', ()=> deletePoll(b.getAttribute('data-id'))));
      }
    }

    // ============== EDITOR ==============
    function loadEditor(id){
      const polls = getPolls();
      const p = polls[id];
      if (!p) return;
      editId.value = id;
      editTitle.value = p.title || '';
      editCategory.value = p.category || '';
      editOptions.value = (p.options || []).join(', ');

      const dt = new Date(p.endTime);
      if (!isNaN(dt)){
        const isoLocal = new Date(dt.getTime() - dt.getTimezoneOffset()*60000).toISOString().slice(0,16);
        editEnd.value = isoLocal;
      } else {
        editEnd.value = '';
      }
      editFeatured.checked = !!p.featured;
      openLink.href = `poll.html?id=${encodeURIComponent(id)}`;

      editHint.classList.add('hidden');
      editForm.classList.remove('hidden');
    }

    document.getElementById('saveBtn')?.addEventListener('click', (e)=>{
      e.preventDefault();
      const id = editId.value;
      const polls = getPolls();
      const p = polls[id];
      if (!p) return;

      p.title = editTitle.value.trim() || p.title;
      p.category = editCategory.value.trim() || p.category;
      p.options = editOptions.value.split(',').map(s=>s.trim()).filter(Boolean);
      if (editEnd.value){
        const dt = new Date(editEnd.value);
        p.endTime = new Date(dt.getTime() + dt.getTimezoneOffset()*60000).toISOString(); // local->UTC
      }
      p.featured = !!editFeatured.checked;
      polls[id] = p;
      setPolls(polls);
      render();
    });

    function toggleFeature(id){
      const polls = getPolls(); if (!polls[id]) return;
      polls[id].featured = !polls[id].featured;
      setPolls(polls); render();
    }
    function closeNow(id){
      const polls = getPolls(); if (!polls[id]) return;
      polls[id].endTime = new Date(Date.now()-1000).toISOString();
      setPolls(polls); render();
    }
    function deletePoll(id){
      if (!confirm('Delete this poll? This cannot be undone.')) return;
      const polls = getPolls(); delete polls[id]; setPolls(polls); render();
    }

    // ============== EXPORT / IMPORT ==============
    document.getElementById('exportBtn')?.addEventListener('click', ()=>{
      const data = JSON.stringify(getPolls(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'votehive-polls-backup.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    document.getElementById('importInput')?.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if (!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if (!data || typeof data !== 'object') throw new Error('Invalid file');
        setPolls(data);
        render();
        alert('Import complete.');
      }catch(err){
        alert('Import failed: ' + err.message);
      }finally{
        e.target.value = '';
      }
    });

    // ============== FILTERS ==============
    document.getElementById('search')?.addEventListener('input', render);
    document.getElementById('filterState')?.addEventListener('change', render);
  </script>
</body>
</html>